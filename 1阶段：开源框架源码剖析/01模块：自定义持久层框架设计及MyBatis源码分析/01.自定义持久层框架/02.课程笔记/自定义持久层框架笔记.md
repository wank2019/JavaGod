# è‡ªå®šä¹‰æŒä¹…å±‚æ¡†æ¶

## è¯´åœ¨å‰é¢
- **æœ¬ç« ç›¸å…³ä»£ç åŠç¬”è®°åœ°å€ï¼š**[**é£æœºç¥¨ğŸš€**](https://github.com/EayonLee/JavaGod/tree/main/1é˜¶æ®µï¼šå¼€æºæ¡†æ¶æºç å‰–æ/01æ¨¡å—ï¼šè‡ªå®šä¹‰æŒä¹…å±‚æ¡†æ¶è®¾è®¡åŠMyBatisæºç åˆ†æ)
- **ğŸš€Javaè¶…ç¥ä¹‹è·¯ï¼š**[**ã€ğŸ”Javaå…¨ç”Ÿæ€æŠ€æœ¯å­¦ä¹ ç¬”è®°ï¼Œä¸€èµ·è¶…ç¥å§ğŸ”ã€‘**](https://github.com/EayonLee/JavaGod)


## ç›®å½•

[TOC]



## æ¦‚è¿°

â€‹	å¸‚é¢ä¸Šæœ‰è®¸å¤šçš„æŒä¹…å±‚æ¡†æ¶ï¼Œå¦‚ï¼š``Mybatis``ã€``SpringData JPA``......ã€‚ä»–ä»¬éƒ½æ˜¯åŸºäºJDBCçš„å°è£…ï¼Œé‚£ä¹ˆæˆ‘ä»¬æƒ³è¦å»è‡ªå®šä¹‰æŒä¹…å±‚æ¡†æ¶å°±å¾—äº†è§£JDBCï¼Œç›¸ä¿¡å¤§å®¶éƒ½äº†è§£è¿‡JDBCï¼ŒçŸ¥é“ä½¿ç”¨JDBCè¿›è¡ŒæŒä¹…åŒ–æ“ä½œéå¸¸çš„å¤æ‚ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸‹é¢å°±æ¥åˆ†æJDBCçš„ä»£ç ç¼ºé™·ï¼Œè¿™æ ·æ‰èƒ½æ›´å¥½çš„è‡ªå®šä¹‰æŒä¹…å±‚æ¡†æ¶ã€‚



## ä¸€.  åˆ†æJDBCæ“ä½œé—®é¢˜

ä»¥ä¸‹æ˜¯é€šè¿‡JDBCè¿æ¥æ•°æ®åº“è¿›è¡ŒæŸ¥è¯¢æ“ä½œçš„ç¤ºä¾‹ä»£ç ï¼Œæˆ‘ä»¬æ¥åˆ†æï¼Œè¿™æ ·è¿›è¡Œæ•°æ®æŸ¥è¯¢ä¼šæœ‰å“ªäº›é—®é¢˜ã€‚

![](https://cdn.jsdelivr.net/gh/EayonLee/IMG-Cloud@master/data/jdbcä»£ç .png)

### 1.1 ä¸€å¼ å›¾è§£æä¼ ç»ŸJDBCä»£ç çš„ç¼ºé™·

![](https://cdn.jsdelivr.net/gh/EayonLee/IMG-Cloud@master/data/jdbcé—®é¢˜åˆ†æ.png)

**åŸå§‹JDBCå¼€å‘å­˜åœ¨çš„é—®é¢˜å¦‚ä¸‹ï¼š**

1. æ•°æ®åº“è¿æ¥åˆ›å»ºã€é‡Šæ”¾é¢‘ç¹é€ æˆç³»ç»Ÿèµ„æºæµªè´¹ï¼Œä»è€Œå½±å“ç³»ç»Ÿæ€§èƒ½ã€‚
2. SQLè¯­å¥åœ¨ä»£ç ä¸­ç¡¬ç¼–ç ï¼Œé€ æˆä»£ç ä¸æ˜“ç»´æŠ¤ï¼Œå®é™…åº”ç”¨ä¸­sqlå˜åŒ–çš„å¯èƒ½è¾ƒå¤§ï¼ŒSQLå˜åŠ¨éœ€è¦æ”¹å˜Javaä»£ç ã€‚
3. ä½¿ç”¨``preparedStatement``å‘å æœ‰ä½ç¬¦å·ä¼ å‚æ•°å­˜åœ¨ç¡¬ç¼–ç ï¼Œå› ä¸ºSQLè¯­å¥çš„``where``æ¡ä»¶ä¸ä¸€å®šï¼Œå¯èƒ½å¤šä¹Ÿå¯èƒ½å°‘ï¼Œä¿®æ”¹SQLè¿˜è¦ä¿®æ”¹ä»£ç ï¼Œç³»ç»Ÿä¸æ˜“ç»´æŠ¤ã€‚
4. å¯¹ç»“æœé›†è§£æå­˜åœ¨ç¡¬ç¼–ç (æŸ¥è¯¢åˆ—å)ï¼ŒSQLå˜åŒ–å¯¼è‡´è§£æä»£ç å˜åŒ–ï¼Œç³»ç»Ÿä¸æ˜“ç»´æŠ¤ï¼Œå¦‚æœèƒ½å°†æ•°æ®åº“è®°å½•å°è£…æˆpojoå¯¹è±¡è§£ææ¯”è¾ƒæ–¹ä¾¿ã€‚

### 1.2  åŸå§‹JDBCå¼€å‘å­˜åœ¨é—®é¢˜è§£å†³æ–¹æ¡ˆ

![img](https://cdn.jsdelivr.net/gh/EayonLee/IMG-Cloud@master/data/javagodæˆç¥ä¹‹è·¯.png)



## äºŒ. è‡ªå®šä¹‰æŒä¹…å±‚æ¡†æ¶è®¾è®¡æ€è·¯

> ä»¥ä¸‹æ‰€æœ‰ä½¿ç”¨åˆ°çš„æ–‡ä»¶åã€ç±»åæˆ–å˜é‡åç­‰éƒ½æ˜¯æˆ‘è‡ªå®šä¹‰çš„ï¼Œå¦‚æœå’ŒMyBatisé›·åŒçº¯å±å·§åˆï¼ˆå“ˆå“ˆå“ˆï¼‰ï¼Œå¤§å®¶ä¹Ÿå¯ä»¥éšä¾¿å®šä¹‰ã€‚

### 2.1 å®¢æˆ·ç«¯

**å•¥æ˜¯å®¢æˆ·ç«¯ï¼Ÿ**ï¼šå¯ç†è§£ä¸ºæ˜¯ä¸€ä¸ªä½¿ç”¨æˆ‘ä»¬è‡ªå®šä¹‰æŒä¹…å±‚æ¡†æ¶çš„é¡¹ç›®ã€‚

â€‹	æŒ‰ç…§æˆ‘ä»¬åŸæ¥ä½¿ç”¨Mybatisçš„ç»éªŒï¼Œæˆ‘ä»¬çŸ¥é“å®¢æˆ·ç«¯éœ€è¦æä¾›ä¸¤ä¸ªæ ¸å¿ƒé…ç½®ä¿¡æ¯ï¼šæ•°æ®åº“é…ç½®ä¿¡æ¯ã€SQLé…ç½®ä¿¡æ¯ã€‚

â€‹	è€Œä¸”æ ¹æ®ä¸Šé¢æˆ‘ä»¬åˆ†æJDBCçš„ç¼ºé™·æ—¶ï¼Œæ•°æ®åº“é…ç½®ä¿¡æ¯å’ŒSQLé…ç½®ä¿¡æ¯éƒ½æ˜¯å†™æ­»åœ¨ä»£ç ä¸­çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬è‡ªå®šä¹‰çš„æ—¶å€™è‚¯å®šä¸èƒ½å†™æ­»åœ¨ä»£ç é‡Œï¼Œæˆ‘ä»¬éœ€è¦å†™åœ¨é…ç½®æ–‡ä»¶ä¸­ã€‚

#### ï¼ˆ1ï¼‰æä¾›é…ç½®æ–‡ä»¶ä¾›æŒä¹…å±‚æ¡†æ¶è¯»å–ï¼š

* **sqlMapConfig.xml**ï¼šå­˜æ”¾æ•°æ®åº“é…ç½®ä¿¡æ¯

* **mapper.xml**ï¼šSQLé…ç½®ä¿¡æ¯ï¼šSQLè¯­å¥ã€å‚æ•°ç±»å‹ã€è¿”å›å€¼ç±»å‹



### 2.2 è‡ªå®šä¹‰æŒä¹…å±‚æ¡†æ¶ç«¯

**å•¥æ˜¯è‡ªå®šä¹‰æŒä¹…å±‚æ¡†æ¶ç«¯ï¼Ÿ**ï¼šå…¶å®å°±æ˜¯å¯¹JDBCå°è£…çš„ä¸€ä¸ªå·¥å‚ï¼Œä¾›å®¢æˆ·ç«¯ä½¿ç”¨ã€‚

â€‹	æˆ‘ä»¬çŸ¥é“è‡ªå®šä¹‰æŒä¹…å±‚æ¡†æ¶å…¶å®æœ¬è´¨æ˜¯å¯¹JDBCä»£ç è¿›è¡Œå°è£…ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦åšä»¥ä¸‹ä¸€äº›å·¥ä½œï¼š

#### ï¼ˆ1ï¼‰è¯»å–å®¢æˆ·ç«¯æä¾›çš„é…ç½®æ–‡ä»¶ï¼š

* åˆ›å»º``Resources``ç±»ï¼Œå¹¶å®šä¹‰``getResourcesAsStream(String path)``æ–¹æ³•å°†é…ç½®æ–‡ä»¶è¯»å–æˆå­—èŠ‚æµå­˜å‚¨ä¸å†…å­˜ä¸­å¹¶è¿”å›ã€‚

  **æ€è€ƒ**ï¼šæˆ‘ä»¬ç°åœ¨å¯ä»¥ç”¨``getResourceAsStream()``æ–¹æ³•å»åŠ è½½é…ç½®æ–‡ä»¶ï¼Œä½†æ˜¯å®¢æˆ·ç«¯æœ‰ä¸¤ä¸ªé…ç½®æ–‡ä»¶éš¾é“æˆ‘ä»¬å°±è¦å»åŠ è½½ä¸¤æ¬¡å—ï¼Ÿ

  â€‹			å…¶å®æˆ‘ä»¬å¯ä»¥å°†``*mapper.xml``é…ç½®æ–‡ä»¶çš„å…¨è·¯å¾„å­˜æ”¾äº``sqlMapConfig.xml``ä¸­ï¼Œè¿™æ ·æˆ‘ä»¬åªéœ€è¦åŠ è½½ä¸€æ¬¡``sqlMapConfig.xmlå°±			å¯ä»¥å…¨éƒ¨è·å–äº†ã€‚

#### ï¼ˆ2ï¼‰åˆ›å»ºä¸¤ä¸ªå®¹å™¨å¯¹è±¡ï¼š

â€‹		ä»ç¬¬ä¸€æ­¥æ¥çœ‹ï¼Œæˆ‘ä»¬åªæ˜¯å°†é…ç½®æ–‡ä»¶è¯»å–åˆ°äº†å†…å­˜ä¸­ï¼Œè€Œå†…å­˜ä¸­çš„æ•°æ®æˆ‘ä»¬æ˜¯ä¸æ˜¯ä¸æ–¹ä¾¿æ“ä½œï¼Ÿæ‰€ä»¥æˆ‘ä»¬è¦åŸºäºJavaé¢å‘å¯¹è±¡çš„æ€	æƒ³ï¼Œå°†è¿™ä¸¤ä¸ªé…ç½®æ–‡ä»¶è§£	æä¸º	ä¸¤ä¸ªJava Beanï¼š``Configuration`` ã€``MappedStatement``

* **Configurationï¼ˆæ ¸å¿ƒé…ç½®ç±»ï¼‰**: å­˜æ”¾æ•°æ®åº“åŸºæœ¬ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯å®¢æˆ·ç«¯æä¾›çš„``sqlMapConfig.xml``é…ç½®æ–‡ä»¶çš„å†…å®¹

* **MappedStatementï¼ˆæ˜ å°„é…ç½®ç±»ï¼‰**ï¼šå­˜æ”¾SQLè¯­å¥ã€å‚æ•°ç±»å‹ã€è¿”å›å€¼ç±»å‹ï¼Œä¹Ÿå°±æ˜¯å­˜æ”¾``*mapper.xml``é…ç½®æ–‡ä»¶çš„å†…å®¹

#### ï¼ˆ3ï¼‰è§£æé…ç½®æ–‡ä»¶ï¼š

* åˆ›å»º``XMLConfigBuilder``ç±»å¹¶å®šä¹‰``parseConfig(InputStream is)``æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä½¿ç”¨``dom4j``å°†``sqlMapConfig.xml``åœ¨å†…å­˜ä¸­çš„å­—èŠ‚æµå°è£…åˆ°``Configuration``é…ç½®å®ä½“å¹¶è¿”å›ã€‚

* åˆ›å»º``XMLMapperBuilder``ç±»å¹¶å®šä¹‰``parse(InputStream is)``æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä½¿ç”¨``dom4j``å°†``*mapper.xml``åœ¨å†…å­˜ä¸­çš„å­—èŠ‚æµå°è£…åˆ°``MappedStatement``é…ç½®å®ä½“ï¼Œå¹¶å°†è¯¥å®ä½“èµ‹å€¼ç»™``Configuration``ä¸­çš„å±æ€§ã€‚

- åˆ›å»ºä¸€ä¸ªæ„å»ºè€…ç±»SqlSessionFactoryBuilderï¼Œç±»ä¸­æœ‰ä¸ªæ–¹æ³•ï¼šbuild(InputStream is)ï¼Œé‚£buildä¸­çš„å‚æ•°ä¹Ÿå°±æ˜¯å†…å­˜ä¸­å®¢æˆ·ç«¯æä¾›çš„sqlMapConfig.xmlæ–‡ä»¶æµã€‚SqlSessionFactoryBuilderä¼šé€šè¿‡é…ç½®æ–‡ä»¶åˆ›å»ºä¸€ä¸ªSqlSessionFactoryå·¥å‚ï¼Œé€šè¿‡sessionå·¥å‚ç”Ÿäº§sessionã€‚

#### ï¼ˆ4ï¼‰åˆ›å»ºSqlSessionFactoryæ¥å£åŠå®ç°ç±»DefaultSqlSessionFactoryï¼š

- åˆ›å»º``SqlSessionFactory``æ¥å£åŠå®ç°ç±»``DefaultSqlSessionFactory``Sessionå·¥å‚ï¼Œå¹¶æä¾›ä¸€ä¸ªopenSession() æ–¹æ³•æ¥ç”Ÿäº§sqlSessionï¼ˆä¼šè¯å¯¹è±¡ï¼‰ï¼Œé‚£å…¶å®æˆ‘ä»¬å¯¹æ•°æ®çš„å¢åˆ æ”¹æŸ¥æ–¹æ³•éƒ½å°è£…åœ¨sqlSessionä¸­ã€‚

#### ï¼ˆ5ï¼‰åˆ›å»ºSqlSessionæ¥å£åŠå®ç°ç±»DefaultSqlSessionï¼š

â€‹	``SqlSession``ä¸»è¦å°è£…äº†ä¸€äº›å¯¹æ•°æ®åº“CRUDï¼ˆå¢åˆ æ”¹æŸ¥ï¼‰æ“ä½œçš„æ–¹æ³•

- æä¾›``selectList()``æ–¹æ³•ï¼šæŸ¥è¯¢æ‰€æœ‰æ•°æ®
- æä¾›``selectOne()``ï¼šæŸ¥è¯¢å•ä¸ª
- æä¾›``update()``ï¼šä¿®æ”¹
- æä¾›``delete()``ï¼šåˆ é™¤

#### ï¼ˆ6ï¼‰åˆ›å»ºExecutoræ¥å£åŠå®ç°ç±»SimpleExecutorï¼š

- åˆ›å»ºExecutoræ¥å£åŠå®ç°ç±»SimpleExecutorå¹¶æä¾›``query(Configuration c, MappedStatement m, Object...param)``æ–¹æ³•ï¼Œç”¨äºæ‰§è¡Œå°è£…çš„jdbcä»£ç 

  **è§£é‡Š**ï¼šæœ¬æ­¥æ“ä½œå…¶å®å°±æ˜¯å°†jdbcçš„å¢åˆ æ”¹æŸ¥æ–¹æ³•å°è£…åˆ°``Executor``æ¥å£åŠå®ç°ç±»``SimpleExcutor``æ¥åšè¿›ä¸€æ­¥çš„å°è£…ï¼Œè¿™ä¸ªqeuryæ–¹æ³•å…¶å®å°±æ˜¯å¯¹jdbcåŸå§‹æŸ¥è¯¢æ“ä½œçš„å°è£…ã€‚å‚æ•°åˆ†åˆ«ä¸ºï¼šæ ¸å¿ƒé…ç½®æ–‡ä»¶ã€*mapperæ˜ å°„æ–‡ä»¶ã€æŸ¥è¯¢å‚æ•°ã€‚é‚£ä¹ˆæ¯”å¦‚ä½¿ç”¨``DefaultSqlSession``ä¸­``selectList()``æ–¹æ³•è°ƒç”¨çš„ä¹Ÿå°±æ˜¯``SimpleExcutor``ä¸­å°è£…çš„``query()``æ–¹æ³•ã€‚

#### ï¼ˆ7ï¼‰åˆ›å»ºSqlSessionFactoryBuilderï¼š

- åˆ›å»º``SqlSessionFactoryBuilder``ç±»ï¼Œå¹¶å®šä¹‰``build(InputStream is)``æ–¹æ³•ï¼Œ``build``ä¸­çš„å‚æ•°ä¹Ÿå°±æ˜¯``sqlMapConfig.xml``æ–‡ä»¶æµã€‚

- ``build()``ä¸­ä¼šè°ƒç”¨``XMLConfigBuilder.parseConfig(inputStream)``æ–¹æ³•å°†æ–‡ä»¶æµä½¿ç”¨``dom4j``è§£ææˆ``Configuration``å¯¹è±¡ã€‚

- ç„¶åé€šè¿‡``Configuration``é…ç½®å®ä½“ä½œä¸ºå‚æ•°æ„å»ºDefaultSqlSessionFactoryå·¥å‚å¹¶è¿”å›ã€‚

  **è§£é‡Š**ï¼šå½“å®¢æˆ·ç«¯ä½¿ç”¨``Resources.getResourceAsStream(sqlmapConfig.xml)``è·å–åˆ°é…ç½®æ–‡ä»¶å­—èŠ‚æµåï¼Œé€šè¿‡``SqlSessionFactoryBuilder.build(resourceAsStream)``æ–¹æ³•å°†å­—èŠ‚æµæ„å»ºæˆ``SqlSessionFactory``å·¥å‚ã€‚æ‰€ä»¥``SqlSessionFactory``ä¸­åŒ…å«äº†å®¢æˆ·ç«¯æä¾›çš„é…ç½®ä¿¡æ¯ã€‚ç„¶åå®¢æˆ·ç«¯å†é€šè¿‡``SqlSessionFactory.openSession()``æ–¹æ³•å»ç”Ÿäº§``SqlSession``ï¼Œé‚£è¿™ä¸ªæ—¶å€™SqlSessionä¸­ä¹ŸåŒ…å«é…ç½®ä¿¡æ¯ã€‚é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡``SqlSession``ä¸­çš„CRUDæ–¹æ³•ï¼Œå°†é…ç½®ä¿¡æ¯åœ¨ç»™åˆ°``SimpleExecutor``ä¸­å…·ä½“çš„JDBCä»£ç ä¸­å®ç°å®Œæ•´çš„ä¸€å¥—æµç¨‹ã€‚

  

### 2.3 æ‰§è¡Œæµç¨‹å›¾

![image-20210301162130434](https://cdn.jsdelivr.net/gh/EayonLee/IMG-Cloud@master/data/image-20210301162130434.png)



## ä¸‰. è‡ªå®šä¹‰æŒä¹…å±‚æ¡†æ¶å®ç°

> æºç åœ°å€ï¼š[é£æœºç¥¨âœˆ](https://github.com/EayonLee/JavaGod/tree/main/1%E9%98%B6%E6%AE%B5%EF%BC%9A%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/01%E6%A8%A1%E5%9D%97%EF%BC%9A%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8C%81%E4%B9%85%E5%B1%82%E6%A1%86%E6%9E%B6%E8%AE%BE%E8%AE%A1%E5%8F%8AMyBatis%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/01.%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8C%81%E4%B9%85%E5%B1%82%E6%A1%86%E6%9E%B6/01.%E8%AF%BE%E7%A8%8B%E8%B5%84%E6%96%99)

### 3.1 è¯»å–é…ç½®æ–‡ä»¶

**è‡ªå®šä¹‰æŒä¹…å±‚æ¡†æ¶ç«¯**

* **ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºè‡ªå®šä¹‰æŒä¹…å±‚æ¡†æ¶é¡¹ç›®ï¼Œé¡¹ç›®åï¼š``Ipersistence``**

* **ç¬¬äºŒæ­¥ï¼šæ·»åŠ pomåæ ‡**

  ```xml
  <dependencies>
      <!--mysql-->
      <dependency>
          <groupId>mysql</groupId>
          <artifactId>mysql-connector-java</artifactId>
          <version>5.1.17</version>
      </dependency>
      <!--dom4j-->
      <dependency>
          <groupId>dom4j</groupId>
          <artifactId>dom4j</artifactId>
          <version>1.6.1</version>
      </dependency>
      <!--c3p0-->
      <dependency>
          <groupId>c3p0</groupId>
          <artifactId>c3p0</artifactId>
          <version>0.9.1.2</version>
      </dependency>
      <!--junit-->
      <dependency>
          <groupId>junit</groupId>
          <artifactId>junit</artifactId>
          <version>4.10</version>
      </dependency>
      <!--jaxen-->
      <dependency>
          <groupId>jaxen</groupId>
          <artifactId>jaxen</artifactId>
          <version>1.1.6</version>
      </dependency>
  </dependencies>
  ```

* **ç¬¬ä¸‰æ­¥ï¼šåˆ›å»ºResourcesç±»ï¼Œç”¨äºè¯»å–å®¢æˆ·ç«¯æä¾›çš„é…ç½®æ–‡ä»¶**

  > åœ¨``com.eayon.io``ç›®å½•ä¸‹åˆ›å»º``Resources``ç±»ï¼Œç±»ä¸­å®šä¹‰``getResourceAsStream(String path)``æ–¹æ³•å»åŠ è½½é…ç½®æ–‡ä»¶ï¼Œæ–¹æ³•è¿”å›å€¼``InputStream``

  ```java
  package com.eayon.io;
  
  import java.io.InputStream;
  
  /**
   * æ ¹æ®å®¢æˆ·ç«¯çš„é…ç½®æ–‡ä»¶è·¯å¾„å°†é…ç½®æ–‡ä»¶è¯»å–æˆå­—èŠ‚è¾“å…¥æµçš„å½¢å¼å­˜å‚¨äºå†…å­˜ä¸­
   */
  public class Resources {
  
      /**
       * å¯å°†æ–‡ä»¶è¯»å–æˆå­—èŠ‚æµçš„å½¢å¼å­˜å‚¨äºå†…å­˜å¹¶è¿”å›
       *
       * @param path é…ç½®æ–‡ä»¶è·¯å¾„
       * @return
       */
      public static InputStream getResourceAsStream(String path) {
          InputStream resourceAsStream = Resources.class.getClassLoader().getResourceAsStream(path);
          return resourceAsStream;
      }
  
  }
  ```

* **ç¬¬å››æ­¥ï¼šå°†è‡ªå®šä¹‰æŒä¹…å±‚æ¡†æ¶é¡¹ç›®æ‰“åŒ…è‡³æœ¬åœ°Mavenä»“åº“**



**å®¢æˆ·ç«¯**

* **ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºå®¢æˆ·ç«¯é¡¹ç›®ï¼Œé¡¹ç›®åï¼š``Ipersistence_test``**

* **ç¬¬äºŒæ­¥ï¼šåˆ›å»ºæ•°æ®åº“æ ¸å¿ƒé…ç½®æ–‡ä»¶ï¼šSqlMapConfig.xml**

  åœ¨``resources``ç›®å½•ä¸‹åˆ›å»ºå¦‚ä¸‹``SqlMapConfig.xml``æ ¸å¿ƒé…ç½®æ–‡ä»¶

  ```xml
  <!--æ•°æ®åº“æ ¸å¿ƒé…ç½®æ–‡ä»¶-->
  <configuration>
  
      <!--æ•°æ®æºé…ç½®ä¿¡æ¯-->
      <dataSource>
          <property name="driverClass" value="com.mysql.jdbc.Driver"></property><!--Mysqlæ•°æ®åº“é©±åŠ¨-->
          <property name="jdbcUrl" value="jdbc:mysql:///eayon_mybatis"></property><!--è¿æ¥çš„æ•°æ®åº“åœ°å€  æ•°æ®åº“è‡ªè¡Œåˆ›å»º-->
          <property name="username" value="root"></property><!--æ•°æ®åº“è´¦å·-->
          <property name="password" value="1234"></property><!--æ•°æ®åº“å¯†ç -->
      </dataSource>
  
      <!--å­˜æ”¾ *mapper.xmlçš„å…¨è·¯å¾„-->
      <mapper resource="UserMapper.xml"></mapper>
  </configuration>
  ```

* **ç¬¬ä¸‰æ­¥ï¼šåˆ›å»ºMapperæ˜ å°„é…ç½®æ–‡ä»¶**

  åœ¨``resources``ç›®å½•ä¸‹åˆ›å»ºå¦‚ä¸‹``UserMapper.xml``é…ç½®æ–‡ä»¶

  ```xml
  <!-- namespaceï¼šå½“å‰UserMapper.xmlçš„å”¯ä¸€æ ‡è¯†-->
  <mapper namespace="user">
  
      <!--æŸ¥è¯¢æ‰€æœ‰-->
      <!-- idï¼šå½“å‰selectæ ‡ç­¾çš„å”¯ä¸€æ ‡è¯†-->
      <!--æƒ³è¦ç²¾å‡†å®šä½åˆ°å½“å‰è¿™æ¡SQLè¯­å¥ï¼šæ˜¯é€šè¿‡ namespaceå’Œè¯¥æ¡selectæ ‡ç­¾ä¸­çš„idæ¥ç»„æˆä¸€ä¸ªstatementIdæ¥è¿›è¡Œå®šä½çš„ ï¼Œ å¦‚è¯¥æ¡SQLçš„statementIdä¸º user.selectList-->
      <!--resultTypeï¼šè¯¥æ¡SQLè¯­å¥è¿”å›ç»“æœçš„è¿”å›å€¼ç±»å‹-->
      <select id="selectList" restType="com.eayon.pojo.User">
          select * from user
      </select>
  
      <!--æ¡ä»¶æŸ¥è¯¢-->
      <!--paramterTypeï¼šå‚æ•°ç±»å‹-->
      <select id="selectOne" restType="com.eayon.pojo.User"  paramterType="com.eayon.pojo.User">
          select * from user where id = #{id} and username = #{username}
      </select>
  
  </mapper>
  ```

* **ç¬¬å››æ­¥ï¼šæ·»åŠ pomåæ ‡ï¼ˆè‡ªå®šä¹‰æŒä¹…å±‚æ¡†æ¶æ‰“åŒ…åçš„åæ ‡ï¼‰**

  ```xml
  <!--å¼•å…¥è‡ªå®šä¹‰æŒä¹…å±‚æ¡†æ¶çš„ä¾èµ–-->
      <dependencies>
          <dependency>
              <groupId>com.eayon</groupId>
              <artifactId>Ipersistence</artifactId>
              <version>1.0-SNAPSHOT</version>
          </dependency>
      </dependencies>
  ```

* **ç¬¬äº”æ­¥ï¼šæµ‹è¯•è¯»å–SqlMapConfig.xmlé…ç½®æ–‡ä»¶**

  åœ¨``com.eayon.test``ä¸‹åˆ›å»º``MyTest``ç±»å¹¶æµ‹è¯•æ˜¯å¦å¯ä»¥è¯»å–æˆåŠŸ

  ```java
  package com.eayon.test;
  
  import com.eayon.io.Resources;
  
  import java.io.InputStream;
  
  /**
   * æµ‹è¯•ç±»
   */
  public class MyTest {
  
      public static void main(String[] args) {
          InputStream resourceAsStream = Resources.getResourceAsStream("sqlMapConfig.xml");
          System.out.println(resourceAsStream);
      }
  }
  ```



### 3.2 å®¹å™¨å¯¹è±¡å®šä¹‰

**è‡ªå®šä¹‰æŒä¹…å±‚æ¡†æ¶ç«¯**

* **ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºMappedStatementå®¹å™¨å¯¹è±¡**

  åœ¨``com.eayon.pojo``ä¸‹åˆ›å»º``MappedStatement``å®¹å™¨å¯¹è±¡

  > æ¯”å¦‚``UserMapper.xml``ä¸­æœ‰ä¸¤ä¸ª``select``æ ‡ç­¾ï¼Œé‚£ä¹ˆåŠ è½½``UserMapper.xml``çš„æ—¶å€™å°±ä¼šäº§ç”Ÿä¸¤ä¸ª``MappedStatement``å®¹å™¨å¯¹è±¡ã€‚

  ```java
  package com.eayon.pojo;
  
  /**
   * æ˜ å°„é…ç½®ç±»ï¼šå­˜æ”¾SQLè¯­å¥ã€å‚æ•°ç±»å‹ã€è¿”å›å€¼ç±»å‹ï¼Œä¹Ÿå°±æ˜¯*mapper.xmlé…ç½®æ–‡ä»¶ä¸­æ¯ä¸€ä¸ªæŒä¹…åŒ–æ“ä½œæ ‡ç­¾çš„å†…å®¹ï¼Œå¦‚æŸä¸€ä¸ªselectæ ‡ç­¾
   * ä¸€ä¸ª*mapper.xmlé…ç½®æ–‡ä»¶å¯èƒ½ä¼šè§£æå‡ºæ¥å¤šä¸ªMappedStatement
   */
  public class MappedStatement {
  
      //idæ ‡è¯†
      private String id;
      //è¿”å›å€¼ç±»å‹
      private String resultType;
      //å‚æ•°å€¼ç±»å‹
      private String paramterType;
      //sqlè¯­å¥
      private String sql;
  
      public String getId() {
          return id;
      }
  
      public void setId(String id) {
          this.id = id;
      }
  
      public String getResultType() {
          return resultType;
      }
  
      public void setResultType(String resultType) {
          this.resultType = resultType;
      }
  
      public String getParamterType() {
          return paramterType;
      }
  
      public void setParamterType(String paramterType) {
          this.paramterType = paramterType;
      }
  
      public String getSql() {
          return sql;
      }
  
      public void setSql(String sql) {
          this.sql = sql;
      }
  }
  ```

* **ç¬¬äºŒæ­¥ï¼šåˆ›å»ºConfigurationå®¹å™¨å¯¹è±¡**

  åœ¨``com.eayon.pojo``ä¸‹åˆ›å»º``Configuration``æ ¸å¿ƒé…ç½®ç±»

  > æˆ‘ä»¬åœ¨ä½¿ç”¨``dom4j``åŠ è½½``sqlMapConfig.xml``æ ¸å¿ƒé…ç½®æ–‡ä»¶æ—¶å°±å°†``dataSource``è¿™ä¸ªæ ‡ç­¾ä¸­çš„å±æ€§å€¼è§£æå¹¶åˆ›å»ºæˆæ•°æ®æºå¯¹è±¡èµ‹å€¼åˆ°è¯¥``Configuration``æ ¸å¿ƒé…ç½®ç±»çš„``dataSource``å±æ€§ä¸­
  >
  > è€Œä¸”åœ¨ä¹‹å‰æˆ‘ä»¬æåˆ°``sqlMapConfig.xml``ä¸­é…ç½®äº†`` *mapper.xml``çš„å…¨è·¯å¾„ï¼Œæ‰€ä»¥è§£æçš„æ—¶å€™åŒæ ·ä¼šè§£æåˆ° ``*mapper.xml``ï¼Œæ¯”å¦‚``Usermapper.xml``ä¸­å­˜åœ¨å¤šä¸ªæŒä¹…åŒ–æ ‡ç­¾å°±ä¼šåˆ›å»ºå¤šä¸ª``MappedStatement``å®¹å™¨å¯¹è±¡ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç”¨Mapé›†åˆæ¥å­˜æ”¾è¿™å¤šä¸ª``MappedStatement``ã€‚

  Mapé›†åˆçš„Keyï¼š ``statementId``  (namespace.id)ï¼Œé€šè¿‡``statementId``å¯ä»¥å®šä½åˆ°æ¯ä¸€æ¡SQL

  Mapé›†åˆä¸­çš„Valueï¼šæ¯æ¡SQLçš„é…ç½®ç±»``MappedStatement``

  ```java
  package com.eayon.pojo;
  
  import javax.sql.DataSource;
  import java.util.HashMap;
  import java.util.Map;
  
  /**
   * æ ¸å¿ƒé…ç½®ç±»ï¼šå­˜æ”¾æ•°æ®åº“åŸºæœ¬ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯å®¢æˆ·ç«¯æä¾›çš„sqlMapConfig.xmlé…ç½®æ–‡ä»¶çš„å†…å®¹
   */
  public class Configuration {
  
      //æ•°æ®æºé…ç½®ä¿¡æ¯ï¼šä½¿ç”¨dom4jè§£æsqlMapConfig.xmlæ—¶ä¼šè§£æåˆ°dataSourceè¿™ä¸ªæ ‡ç­¾ä¸­çš„å±æ€§å€¼å¹¶åˆ›å»ºæˆæ•°æ®æºå¯¹è±¡èµ‹å€¼ç»™æœ¬ç±»çš„dataSourceå±æ€§
      private DataSource dataSource;
  
      //åœ¨sqlMapConfig.xmlä¸­ä¼šå­˜æ”¾*mapper.xmlçš„å…¨è·¯å¾„å¹¶åŠ è½½
      //é‚£ä¸€ä¸ª*mapper.xmlå¯èƒ½ä¼šè§£æå‡ºæ¥å¤šä¸ªMappedStatement(SQLé…ç½®ä¿¡æ¯)ï¼Œæ‰€ä»¥åœ¨Configurationæˆ‘ä»¬ä½¿ç”¨Mapæ¥è¿›è¡Œå¤šä¸ªå­˜å‚¨
      //Mapé›†åˆä¸­çš„Keyï¼šstatementIdï¼ˆnamespace.idï¼‰ï¼Œé€šè¿‡statementIdå¯ä»¥å®šä½åˆ°æ¯ä¸€æ¡SQLï¼ŒstatementIdæ˜¯ç”±mapper.xmlé…ç½®æ–‡ä»¶ä¸­çš„namespace + "." + id ç»„æˆçš„
      //Mapé›†åˆä¸­çš„Valueï¼šæ¯æ¡SQLçš„é…ç½®ç±»MappedStatement
      Map<String, MappedStatement> mappedStatementMap = new HashMap<>();
  
      public DataSource getDataSource() {
          return dataSource;
      }
  
      public void setDataSource(DataSource dataSource) {
          this.dataSource = dataSource;
      }
  
      public Map<String, MappedStatement> getMappedStatementMap() {
          return mappedStatementMap;
      }
  
      public void setMappedStatementMap(Map<String, MappedStatement> mappedStatementMap) {
          this.mappedStatementMap = mappedStatementMap;
      }
  }
  ```



### 3.3 è§£ææ ¸å¿ƒé…ç½®æ–‡ä»¶

**è‡ªå®šä¹‰æŒä¹…å±‚æ¡†æ¶ç«¯**

> æˆ‘ä»¬å›æƒ³ä¸€ä¸‹ï¼Œæ˜¯ä¸æ˜¯å®¢æˆ·ç«¯é€šè¿‡è‡ªå®šä¹‰æ¡†æ¶çš„``Resources.getResourceAsStream()``æ–¹æ³•æŠŠé…ç½®æ–‡ä»¶è¯»å–æˆå­—èŠ‚æµåï¼Œéœ€è¦é€šè¿‡``SqlSessionFactoryBuilder``çš„``Builder``æ–¹æ³•ï¼Œæ ¹æ®é…ç½®æ–‡ä»¶å­—èŠ‚æµè·å–``SqlSessionFactory``å·¥å‚ï¼Ÿé€šè¿‡``SqlSessionFactory``å»åˆ›å»º``session``ï¼Ÿå†é€šè¿‡``session``å¯¹æ•°æ®åº“è¿›è¡Œæ“ä½œï¼Ÿé‚£æˆ‘ä»¬å°±åƒæ¥åˆ›å»º``SqlSessionFactoryBuilder``ï¼

* **ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºSqlSessionFactoryBuilder**

  åœ¨``com.eayon.sqlSession``ä¸‹åˆ›å»º``SqlSessionFactoryBuilder``ç±»ï¼Œå¹¶å®šä¹‰``build(InputStream is)æ–¹æ³•

  ``build``æ–¹æ³•ä¸­å…·ä½“è¿›è¡Œä¸¤æ­¥æ“ä½œï¼šï¼ˆæš‚ä¸ç¼–å†™å…·ä½“æ“ä½œå†…å®¹ï¼‰

  â€‹		1) ï¼šä½¿ç”¨``dom4j``è§£æé…ç½®æ–‡ä»¶ï¼Œå°†è§£æå‡ºæ¥çš„å†…å®¹å°è£…åˆ°``Configuration``æ ¸å¿ƒé…ç½®ç±»ä¸­

  â€‹		2) ï¼šåˆ›å»º``SqlSessionFactory``å¯¹è±¡å¹¶è¿”å›

  ```java
  package com.eayon.sqlSession;
  
  
  import java.io.InputStream;
  
  /**
   * æ„å»ºè€…ç±»ï¼šç”¨äºåˆ›å»ºSqlSessionFactory
   */
  public class SqlSessionFactoryBuilder {
  
      public SqlsessionFactory build(InputStream is){
          //ç¬¬ä¸€ï¼šä½¿ç”¨dom4jè§£æé…ç½®æ–‡ä»¶ï¼Œå°†è§£æå‡ºæ¥çš„å†…å®¹å°è£…åˆ°Configurationä¸­
  
  
          //ç¬¬äºŒï¼šåˆ›å»ºSqlsessionFactoryå·¥å‚
  
          return null;
      }
  }
  ```

  > ``SqlSessionFactory``æˆ‘ä»¬è¿˜æ²¡æœ‰åˆ›å»ºï¼Œä¼šæŠ¥çº¢ï¼Œæˆ‘ä»¬å…ˆä¸ç®¡ä»–ã€‚

  æˆ‘ä»¬å…ˆæ¥åˆ†æä»£ç ä¸­çš„ç¬¬ä¸€æ­¥ï¼šå¦‚ä½•é€šè¿‡dom4jè§£ææ–‡ä»¶æµå°è£…åˆ°``Configurationä¸­``ï¼Ÿ

  è¿™å°±éœ€è¦åˆ›å»º``XMLConfigBuilder``ç±»æ¥æä¾›è§£æå°è£…çš„æ–¹æ³•ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¿›å…¥ä¸‹ä¸€æ­¥

* **ç¬¬äºŒæ­¥ï¼šåˆ›å»ºXMLConfigBuilderæ¥è§£æSqlMapConfig.xml**

  åœ¨``com.eayon.config``ä¸‹åˆ›å»º``XMLConfigBuilder``å¹¶æä¾›``parseConfig``æ–¹æ³•

  ``parseConfig``æ–¹æ³•åˆ†ä¸ºä¸¤æ­¥ï¼š

  â€‹		1) ï¼šä½¿ç”¨``dom4j``è§£æé…ç½®æ–‡ä»¶ï¼Œå°†è§£æå‡ºæ¥çš„å†…å®¹å°è£…åˆ°``Configuration``æ ¸å¿ƒé…ç½®ç±»ä¸­

  â€‹		2) ï¼šåˆ›å»º``SqlMapConfig.xml``ä¸­é…ç½®çš„``*mapper.xml``çš„å…¨è·¯å¾„æ¥è§£æ``*mapper.xml``é…ç½®æ–‡ä»¶å¹¶å°è£…åˆ°``MappedStatement``é…ç½®ç±»ï¼Œ				å†å°†MappedStatementèµ‹å€¼ç»™Configurationçš„mappedStatementMapå±æ€§ã€‚

  > æœ¬æ­¥éª¤åªå®Œæˆç¬¬ä¸€æ­¥ï¼Œç¬¬äºŒæ­¥è§£æ``*mapper.xml``è¯·å¾€ä¸‹ä¸€æ­¥ç»§ç»­çœ‹

  ```java
  package com.eayon.config;
  
  import com.eayon.pojo.Configuration;
  import com.mchange.v2.c3p0.ComboPooledDataSource;
  import org.dom4j.Document;
  import org.dom4j.DocumentException;
  import org.dom4j.Element;
  import org.dom4j.io.SAXReader;
  
  import java.beans.PropertyVetoException;
  import java.io.InputStream;
  import java.util.List;
  import java.util.Properties;
  
  /**
   * ä½¿ç”¨dom4jè§£æsqlMapConfig.xmlçš„å­—èŠ‚æµå°è£…åˆ°Configurationæ ¸å¿ƒé…ç½®ç±»
   */
  public class XMLConfigBuilder {
  
      //å£°æ˜æ ¸å¿ƒé…ç½®ç±»æˆå‘˜å˜é‡
      private Configuration configuration;
  
      //åœ¨new XMLConfigBuilderçš„æ—¶å€™å°±ä¼šé€šè¿‡æ— å‚æ„é€ ç»™æˆå‘˜å˜é‡configurationè¿›è¡Œèµ‹å€¼
      public XMLConfigBuilder() {
          this.configuration = new Configuration();
      }
  
      /**
       * è¯¥æ–¹æ³•ä½¿ç”¨dom4jå°†sqlMapConfig.xmlåœ¨å†…å­˜ä¸­çš„å­—èŠ‚æµå°è£…åˆ°Configurationæ ¸å¿ƒé…ç½®ç±»å¹¶è¿”å›ã€‚
       *
       * @param is æ ¸å¿ƒé…ç½®æ–‡ä»¶qlMapConfig.xmlçš„å­—èŠ‚æµ
       * @return
       */
      public Configuration parseConfig(InputStream is) throws DocumentException, PropertyVetoException {
  
          /**
           * ç¬¬ä¸€æ­¥ï¼šé€šè¿‡dom4jè§£ææ ¸å¿ƒé…ç½®æ–‡ä»¶å°è£…åˆ°Configurationé…ç½®ç±»
           */
          //é€šè¿‡dom4jè¯»å–æ ¸å¿ƒé…ç½®æ–‡ä»¶å­—èŠ‚æµç”ŸæˆDom
          Document document = new SAXReader().read(is);
          //æ‹¿åˆ°æ ¹å…ƒç´ ï¼Œä¹Ÿå°±æ˜¯sqlMapConfig.xmlæ–‡ä»¶ä¸­çš„configurationæ ‡ç­¾
          Element configElement = document.getRootElement();
          //æŸ¥æ‰¾æ ¹å…ƒç´ ä¸‹æ‰€æœ‰çš„propertyæ ‡ç­¾å…ƒç´ 
          List<Element> propertyElements = configElement.selectNodes("//property");
          //é€šè¿‡Propertieså­˜å‚¨æ•°æ®æºä¿¡æ¯nameä»¥åŠvalueå€¼
          Properties dataSources = new Properties();
          //è·å–æ¯ä¸€ä¸ªpropertyå…ƒç´ çš„nameä»¥åŠvalueå€¼
          for (Element propertyElement : propertyElements) {
              String name = propertyElement.attributeValue("name");
              String value = propertyElement.attributeValue("value");
              //å°†nameã€valueå¯¹åº”çš„å­˜å…¥Properties
              dataSources.setProperty(name,value);
          }
  
          //åˆ›å»ºæ•°æ®åº“è¿æ¥æ± 
          ComboPooledDataSource comboPooledDataSource = new ComboPooledDataSource();
          //è®¾ç½®æ•°æ®æºä¿¡æ¯
          comboPooledDataSource.setDriverClass(dataSources.getProperty("driverClass"));
          comboPooledDataSource.setJdbcUrl(dataSources.getProperty("jdbcUrl"));
          comboPooledDataSource.setUser(dataSources.getProperty("username"));
          comboPooledDataSource.setPassword(dataSources.getProperty("password"));
  
          //å°†æ•°æ®æºå°è£…åˆ°Configurationå¯¹è±¡
          configuration.setDataSource(comboPooledDataSource);
  
          /**
           * ç¬¬äºŒæ­¥ï¼šé€šè¿‡sqlMapConfig.xmlä¸­é…ç½®çš„*mapper.xmlçš„å…¨è·¯å¾„æ¥è§£æ*mapper.xmlå¹¶å°è£…åˆ°MappedStatementé…ç½®ç±»
           *        å†å°†MappedStatementèµ‹å€¼ç»™Configurationçš„mappedStatementMapå±æ€§
           */
  
  
          //è¿”å›æ ¸å¿ƒé…ç½®ç±»
          return configuration;
      }
  }
  ```

* **ç¬¬ä¸‰æ­¥ï¼šåˆ›å»ºXMLMapperBuilderç±»ï¼Œæ¥è§£æ *mapper.xml**

  åœ¨``com.eayon.config``ä¸‹åˆ›å»º``XMLMapperBuilder``å¹¶æä¾›``parse()``æ–¹æ³•

  è¯¥æ–¹æ³•ä½¿ç”¨``dom4j``å°†``mapper.xml``å­—èŠ‚æµè¿›è¡Œè§£æå¹¶å°è£…åˆ°``MappedStatement``é…ç½®å®ä½“ï¼Œå¹¶å°†è¯¥å®ä½“èµ‹å€¼ç»™``Configuration``ä¸­çš„å±æ€§ã€‚

  ```java
  package com.eayon.config;
  
  import com.eayon.pojo.Configuration;
  import com.eayon.pojo.MappedStatement;
  import org.dom4j.Document;
  import org.dom4j.DocumentException;
  import org.dom4j.Element;
  import org.dom4j.io.SAXReader;
  
  import java.io.InputStream;
  import java.util.List;
  import java.util.Map;
  
  /**
   * ä½¿ç”¨dom4jè§£æmapper.xml
   */
  public class XMLMapperBuilder {
  
      //å£°æ˜æ ¸å¿ƒé…ç½®ç±»æˆå‘˜å˜é‡
      private Configuration configuration;
  
      //åœ¨ä½¿ç”¨æœ‰å‚æ„é€ newçš„æ—¶å€™ä¼šå°†ä¼ é€’çš„configurationè¿›è¡Œèµ‹å€¼
      public XMLMapperBuilder(Configuration configuration) {
          this.configuration = configuration;
      }
  
      /**
       * è¯¥æ–¹æ³•ä½¿ç”¨dom4jå°†mapper.xmlå­—èŠ‚æµè¿›è¡Œè§£æå¹¶å°è£…åˆ°MappedStatementé…ç½®å®ä½“ï¼Œå¹¶å°†è¯¥å®ä½“èµ‹å€¼ç»™Configurationä¸­çš„å±æ€§ã€‚
       *
       * @param is *mapper.xmlçš„å­—èŠ‚æµ
       */
      public void parse(InputStream is) throws DocumentException {
          //é€šè¿‡dom4jè¯»å–mapper.xmlå­—èŠ‚æµç”ŸæˆDom
          Document document = new SAXReader().read(is);
          //æ‹¿åˆ°æ ¹å…ƒç´ ï¼Œä¹Ÿå°±æ˜¯mapper.xmlæ–‡ä»¶ä¸­çš„mapperæ ‡ç­¾
          Element mapperElement = document.getRootElement();
          //æŸ¥æ‰¾æ ¹å…ƒç´ ä¸‹æ‰€æœ‰çš„selectæ ‡ç­¾å…ƒç´ 
          List<Element> selectElements = mapperElement.selectNodes("//select");
  
          //è·å–æ¯ä¸ªselectæ“ä½œçš„SQLé…ç½®
          for (Element selectElement : selectElements) {
              String id = selectElement.attributeValue("id");
              String resultType = selectElement.attributeValue("resultType");
              String paramterType = selectElement.attributeValue("paramterType");
              String sql = selectElement.getTextTrim();//sqlè¯­å¥
              //å°è£…åˆ°MappedStatement
              MappedStatement mappedStatement = new MappedStatement();
              mappedStatement.setId(id);
              mappedStatement.setResultType(resultType);
              mappedStatement.setParamterType(paramterType);
              mappedStatement.setSql(sql);
              //å°†æ¯ä¸ªMappedStatementå­˜å‚¨åˆ°Configurationçš„MappedStatementMapå±æ€§ä¸­
              Map<String, MappedStatement> mappedStatementMap = configuration.getMappedStatementMap();
              //æ„å»ºmappedStatementMapçš„key ï¼šstatementIdï¼ˆnamespace.idï¼‰ï¼Œé€šè¿‡statementIdå¯ä»¥å®šä½åˆ°æ¯ä¸€æ¡SQL
              String namespace = mapperElement.attributeValue("namespace");
              String statementId = namespace + "." + id;
              mappedStatementMap.put(statementId, mappedStatement);
          }
  
      }
  }
  ```

* **ç¬¬å››æ­¥ï¼šå®Œå–„XMLConfigBuilderç±»ä¸­parseConfig()æ–¹æ³•çš„ç¬¬äºŒæ­¥**

  ```java
  package com.eayon.config;
  
  import com.eayon.io.Resources;
  import com.eayon.pojo.Configuration;
  import com.mchange.v2.c3p0.ComboPooledDataSource;
  import org.dom4j.Document;
  import org.dom4j.DocumentException;
  import org.dom4j.Element;
  import org.dom4j.io.SAXReader;
  
  import java.beans.PropertyVetoException;
  import java.io.InputStream;
  import java.util.List;
  import java.util.Properties;
  
  /**
   * ä½¿ç”¨dom4jè§£æsqlMapConfig.xmlçš„å­—èŠ‚æµå°è£…åˆ°Configurationæ ¸å¿ƒé…ç½®ç±»
   */
  public class XMLConfigBuilder {
  
      //å£°æ˜æ ¸å¿ƒé…ç½®ç±»æˆå‘˜å˜é‡
      private Configuration configuration;
  
      //åœ¨new XMLConfigBuilderçš„æ—¶å€™å°±ä¼šé€šè¿‡æ— å‚æ„é€ ç»™æˆå‘˜å˜é‡configurationè¿›è¡Œèµ‹å€¼
      public XMLConfigBuilder() {
          this.configuration = new Configuration();
      }
  
      /**
       * è¯¥æ–¹æ³•ä½¿ç”¨dom4jå°†sqlMapConfig.xmlåœ¨å†…å­˜ä¸­çš„å­—èŠ‚æµå°è£…åˆ°Configurationæ ¸å¿ƒé…ç½®ç±»å¹¶è¿”å›ã€‚
       *
       * @param is æ ¸å¿ƒé…ç½®æ–‡ä»¶qlMapConfig.xmlçš„å­—èŠ‚æµ
       * @return
       */
      public Configuration parseConfig(InputStream is) throws DocumentException, PropertyVetoException {
  
          /**
           * ç¬¬ä¸€æ­¥ï¼šé€šè¿‡dom4jè§£ææ ¸å¿ƒé…ç½®æ–‡ä»¶å°è£…åˆ°Configurationé…ç½®ç±»
           */
          //é€šè¿‡dom4jè¯»å–æ ¸å¿ƒé…ç½®æ–‡ä»¶å­—èŠ‚æµç”ŸæˆDom
          Document document = new SAXReader().read(is);
          //æ‹¿åˆ°æ ¹å…ƒç´ ï¼Œä¹Ÿå°±æ˜¯sqlMapConfig.xmlæ–‡ä»¶ä¸­çš„configurationæ ‡ç­¾
          Element configElement = document.getRootElement();
          //æŸ¥æ‰¾æ ¹å…ƒç´ ä¸‹æ‰€æœ‰çš„propertyæ ‡ç­¾å…ƒç´ 
          List<Element> propertyElements = configElement.selectNodes("//property");
          //é€šè¿‡Propertieså­˜å‚¨æ•°æ®æºä¿¡æ¯nameä»¥åŠvalueå€¼
          Properties dataSources = new Properties();
          //è·å–æ¯ä¸€ä¸ªpropertyå…ƒç´ çš„nameä»¥åŠvalueå€¼
          for (Element propertyElement : propertyElements) {
              String name = propertyElement.attributeValue("name");
              String value = propertyElement.attributeValue("value");
              //å°†nameã€valueå¯¹åº”çš„å­˜å…¥Properties
              dataSources.setProperty(name,value);
          }
  
          //åˆ›å»ºæ•°æ®åº“è¿æ¥æ± 
          ComboPooledDataSource comboPooledDataSource = new ComboPooledDataSource();
          //è®¾ç½®æ•°æ®æºä¿¡æ¯
          comboPooledDataSource.setDriverClass(dataSources.getProperty("driverClass"));
          comboPooledDataSource.setJdbcUrl(dataSources.getProperty("jdbcUrl"));
          comboPooledDataSource.setUser(dataSources.getProperty("username"));
          comboPooledDataSource.setPassword(dataSources.getProperty("password"));
  
          //å°†æ•°æ®æºå°è£…åˆ°Configurationå¯¹è±¡
          configuration.setDataSource(comboPooledDataSource);
  
          /**
           * ç¬¬äºŒæ­¥ï¼šé€šè¿‡sqlMapConfig.xmlä¸­é…ç½®çš„*mapper.xmlçš„å…¨è·¯å¾„æ¥è§£æ*mapper.xmlå¹¶å°è£…åˆ°MappedStatementé…ç½®ç±»
           *        å†å°†MappedStatementèµ‹å€¼ç»™Configurationçš„mappedStatementMapå±æ€§
           */
          //mapper.xmlè§£æï¼šæ‹¿åˆ°mapper.xmlè·¯å¾„ã€é€šè¿‡dom4jè§£æ
          List<Element> mapperElements = configElement.selectNodes("//mapper");
          //sqlMapConfig.xmlä¸­å¯èƒ½ä¼šé…ç½®å¤šä¸ª*mapper.xmlçš„åœ°å€ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ä¼šè·å–åˆ°å¤šä¸ªåœ°å€
          for (Element mapperElement : mapperElements) {
              String mapperPath = mapperElement.attributeValue("resource");
              //è·å–*mapper.xmlçš„å­—èŠ‚è¾“å…¥æµ
              InputStream mapperStream = Resources.getResourceAsStream(mapperPath);
              XMLMapperBuilder xmlMapperBuilder = new XMLMapperBuilder(configuration);
              xmlMapperBuilder.parse(mapperStream);
          }
  
          //è¿”å›æ ¸å¿ƒé…ç½®ç±»
          return configuration;
      }
  }
  ```

* **ç¬¬äº”æ­¥ï¼šå®Œå–„SqlSessionFactoryBuildç±»ä¸­çš„buildæ–¹æ³•ä¸­çš„ç¬¬ä¸€æ­¥**

  è¿™ä¸ªæ—¶å€™æˆ‘ä»¬ä»¥åŠæŠŠ``sqlMapConfig.xml``ä»¥åŠ``*mapper.xml``é…ç½®æ–‡ä»¶å…¨éƒ¨è§£æåˆ°äº†``Configuration``æ ¸å¿ƒé…ç½®ç±»ä¸­ï¼Œ

  æ¥ä¸‹æ¥è¿›å…¥ä¸‹ä¸€æ­¥ï¼šåˆ›å»º``SqlSessionFactory``æ¥å£åŠå®ç°ç±»``DefaultSqlSessionFactory``

* 

* 

* 

* 

  ```xml
  
  ```















