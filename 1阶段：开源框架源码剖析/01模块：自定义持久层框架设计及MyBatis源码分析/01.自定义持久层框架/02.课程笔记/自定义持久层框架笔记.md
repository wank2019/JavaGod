# è‡ªå®šä¹‰æŒä¹…å±‚æ¡†æ¶

## è¯´åœ¨å‰é¢
>**æœ¬ç« ç›¸å…³ä»£ç åŠç¬”è®°åœ°å€ï¼š**[**é£æœºç¥¨ğŸš€**](https://github.com/EayonLee/JavaGod/tree/main/1%E9%98%B6%E6%AE%B5%EF%BC%9A%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/01%E6%A8%A1%E5%9D%97%EF%BC%9A%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8C%81%E4%B9%85%E5%B1%82%E6%A1%86%E6%9E%B6%E8%AE%BE%E8%AE%A1%E5%8F%8AMyBatis%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/01.%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8C%81%E4%B9%85%E5%B1%82%E6%A1%86%E6%9E%B6)
>
>ğŸŒGithubï¼š[ğŸš€Javaè¶…ç¥ä¹‹è·¯ï¼šã€ğŸ”Javaå…¨ç”Ÿæ€æŠ€æœ¯å­¦ä¹ ç¬”è®°ï¼Œä¸€èµ·è¶…ç¥å§ğŸ”ã€‘](https://github.com/EayonLee/JavaGod)<br>
>ğŸªCSDNï¼š[ğŸš€Javaè¶…ç¥ä¹‹è·¯ï¼šã€ğŸ”Javaå…¨ç”Ÿæ€æŠ€æœ¯å­¦ä¹ ç¬”è®°ï¼Œä¸€èµ·è¶…ç¥å§ğŸ”ã€‘](https://blog.csdn.net/qq_20492277/article/details/114269863)




## ç›®å½•
- [è‡ªå®šä¹‰æŒä¹…å±‚æ¡†æ¶](#è‡ªå®šä¹‰æŒä¹…å±‚æ¡†æ¶)
  - [è¯´åœ¨å‰é¢](#è¯´åœ¨å‰é¢)
  - [ç›®å½•](#ç›®å½•)
  - [æ¦‚è¿°](#æ¦‚è¿°)
  - [ä¸€.  åˆ†æJDBCæ“ä½œé—®é¢˜](#ä¸€--åˆ†æjdbcæ“ä½œé—®é¢˜)
    - [1.1 ä¸€å¼ å›¾è§£æä¼ ç»ŸJDBCä»£ç çš„ç¼ºé™·](#11-ä¸€å¼ å›¾è§£æä¼ ç»Ÿjdbcä»£ç çš„ç¼ºé™·)
    - [1.2  åŸå§‹JDBCå¼€å‘å­˜åœ¨é—®é¢˜è§£å†³æ–¹æ¡ˆ](#12--åŸå§‹jdbcå¼€å‘å­˜åœ¨é—®é¢˜è§£å†³æ–¹æ¡ˆ)
  - [äºŒ. è‡ªå®šä¹‰æŒä¹…å±‚æ¡†æ¶è®¾è®¡æ€è·¯](#äºŒ-è‡ªå®šä¹‰æŒä¹…å±‚æ¡†æ¶è®¾è®¡æ€è·¯)
    - [2.1 å®¢æˆ·ç«¯](#21-å®¢æˆ·ç«¯)
      - [ï¼ˆ1ï¼‰æä¾›é…ç½®æ–‡ä»¶ä¾›æŒä¹…å±‚æ¡†æ¶è¯»å–ï¼š](#1æä¾›é…ç½®æ–‡ä»¶ä¾›æŒä¹…å±‚æ¡†æ¶è¯»å–)
    - [2.2 è‡ªå®šä¹‰æŒä¹…å±‚æ¡†æ¶ç«¯](#22-è‡ªå®šä¹‰æŒä¹…å±‚æ¡†æ¶ç«¯)
      - [ï¼ˆ1ï¼‰è¯»å–å®¢æˆ·ç«¯æä¾›çš„é…ç½®æ–‡ä»¶ï¼š](#1è¯»å–å®¢æˆ·ç«¯æä¾›çš„é…ç½®æ–‡ä»¶)
      - [ï¼ˆ2ï¼‰åˆ›å»ºä¸¤ä¸ªå®¹å™¨å¯¹è±¡ï¼š](#2åˆ›å»ºä¸¤ä¸ªå®¹å™¨å¯¹è±¡)
      - [ï¼ˆ3ï¼‰è§£æé…ç½®æ–‡ä»¶ï¼š](#3è§£æé…ç½®æ–‡ä»¶)
      - [ï¼ˆ4ï¼‰åˆ›å»ºSqlSessionFactoryæ¥å£åŠå®ç°ç±»DefaultSqlSessionFactoryï¼š](#4åˆ›å»ºsqlsessionfactoryæ¥å£åŠå®ç°ç±»defaultsqlsessionfactory)
      - [ï¼ˆ5ï¼‰åˆ›å»ºSqlSessionæ¥å£åŠå®ç°ç±»DefaultSqlSessionï¼š](#5åˆ›å»ºsqlsessionæ¥å£åŠå®ç°ç±»defaultsqlsession)
      - [ï¼ˆ6ï¼‰åˆ›å»ºExecutoræ¥å£åŠå®ç°ç±»SimpleExecutorï¼š](#6åˆ›å»ºexecutoræ¥å£åŠå®ç°ç±»simpleexecutor)
      - [ï¼ˆ7ï¼‰åˆ›å»ºSqlSessionFactoryBuilderï¼š](#7åˆ›å»ºsqlsessionfactorybuilder)
    - [2.3 æ‰§è¡Œæµç¨‹å›¾](#23-æ‰§è¡Œæµç¨‹å›¾)
  - [ä¸‰. è‡ªå®šä¹‰æŒä¹…å±‚æ¡†æ¶å®ç°](#ä¸‰-è‡ªå®šä¹‰æŒä¹…å±‚æ¡†æ¶å®ç°)
    - [3.1 è¯»å–é…ç½®æ–‡ä»¶](#31-è¯»å–é…ç½®æ–‡ä»¶)
    - [3.2 å®¹å™¨å¯¹è±¡å®šä¹‰](#32-å®¹å™¨å¯¹è±¡å®šä¹‰)
    - [3.3 è§£ææ ¸å¿ƒé…ç½®æ–‡ä»¶](#33-è§£ææ ¸å¿ƒé…ç½®æ–‡ä»¶)
    - [3.4 åˆ›å»ºSqlSessionFactoryæ¥å£åŠå®ç°ç±»DefaultSqlSessionFactory](#34-åˆ›å»ºsqlsessionfactoryæ¥å£åŠå®ç°ç±»defaultsqlsessionfactory)
    - [3.5 åˆ›å»ºExecutoræ¥å£åŠå®ç°ç±»SimpleExecutor](#35-åˆ›å»ºexecutoræ¥å£åŠå®ç°ç±»simpleexecutor)
    - [3.6 å®šä¹‰SqlSessionä¸­çš„CRUDæ–¹æ³•](#36-å®šä¹‰sqlsessionä¸­çš„crudæ–¹æ³•)
    - [3.7 å®¢æˆ·ç«¯æµ‹è¯•è¿è¡Œ](#37-å®¢æˆ·ç«¯æµ‹è¯•è¿è¡Œ)
    - [3.8 è‡ªå®šä¹‰æŒä¹…å±‚æ¡†æ¶ä¼˜åŒ–](#38-è‡ªå®šä¹‰æŒä¹…å±‚æ¡†æ¶ä¼˜åŒ–)


## æ¦‚è¿°

â€‹	å¸‚é¢ä¸Šæœ‰è®¸å¤šçš„æŒä¹…å±‚æ¡†æ¶ï¼Œå¦‚ï¼š``Mybatis``ã€``SpringData JPA``......ã€‚ä»–ä»¬éƒ½æ˜¯åŸºäºJDBCçš„å°è£…ï¼Œé‚£ä¹ˆæˆ‘ä»¬æƒ³è¦å»è‡ªå®šä¹‰æŒä¹…å±‚æ¡†æ¶å°±å¾—äº†è§£JDBCï¼Œç›¸ä¿¡å¤§å®¶éƒ½äº†è§£è¿‡JDBCï¼ŒçŸ¥é“ä½¿ç”¨JDBCè¿›è¡ŒæŒä¹…åŒ–æ“ä½œéå¸¸çš„å¤æ‚ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸‹é¢å°±æ¥åˆ†æJDBCçš„ä»£ç ç¼ºé™·ï¼Œè¿™æ ·æ‰èƒ½æ›´å¥½çš„è‡ªå®šä¹‰æŒä¹…å±‚æ¡†æ¶ã€‚



## ä¸€.  åˆ†æJDBCæ“ä½œé—®é¢˜

ä»¥ä¸‹æ˜¯é€šè¿‡JDBCè¿æ¥æ•°æ®åº“è¿›è¡ŒæŸ¥è¯¢æ“ä½œçš„ç¤ºä¾‹ä»£ç ï¼Œæˆ‘ä»¬æ¥åˆ†æï¼Œè¿™æ ·è¿›è¡Œæ•°æ®æŸ¥è¯¢ä¼šæœ‰å“ªäº›é—®é¢˜ã€‚

![](https://cdn.jsdelivr.net/gh/EayonLee/IMG-Cloud@master/data/jdbcä»£ç .png)

### 1.1 ä¸€å¼ å›¾è§£æä¼ ç»ŸJDBCä»£ç çš„ç¼ºé™·

![](https://cdn.jsdelivr.net/gh/EayonLee/IMG-Cloud@master/data/jdbcé—®é¢˜åˆ†æ.png)

**åŸå§‹JDBCå¼€å‘å­˜åœ¨çš„é—®é¢˜å¦‚ä¸‹ï¼š**

1. æ•°æ®åº“è¿æ¥åˆ›å»ºã€é‡Šæ”¾é¢‘ç¹é€ æˆç³»ç»Ÿèµ„æºæµªè´¹ï¼Œä»è€Œå½±å“ç³»ç»Ÿæ€§èƒ½ã€‚
2. SQLè¯­å¥åœ¨ä»£ç ä¸­ç¡¬ç¼–ç ï¼Œé€ æˆä»£ç ä¸æ˜“ç»´æŠ¤ï¼Œå®é™…åº”ç”¨ä¸­sqlå˜åŒ–çš„å¯èƒ½è¾ƒå¤§ï¼ŒSQLå˜åŠ¨éœ€è¦æ”¹å˜Javaä»£ç ã€‚
3. ä½¿ç”¨``preparedStatement``å‘å æœ‰ä½ç¬¦å·ä¼ å‚æ•°å­˜åœ¨ç¡¬ç¼–ç ï¼Œå› ä¸ºSQLè¯­å¥çš„``where``æ¡ä»¶ä¸ä¸€å®šï¼Œå¯èƒ½å¤šä¹Ÿå¯èƒ½å°‘ï¼Œä¿®æ”¹SQLè¿˜è¦ä¿®æ”¹ä»£ç ï¼Œç³»ç»Ÿä¸æ˜“ç»´æŠ¤ã€‚
4. å¯¹ç»“æœé›†è§£æå­˜åœ¨ç¡¬ç¼–ç (æŸ¥è¯¢åˆ—å)ï¼ŒSQLå˜åŒ–å¯¼è‡´è§£æä»£ç å˜åŒ–ï¼Œç³»ç»Ÿä¸æ˜“ç»´æŠ¤ï¼Œå¦‚æœèƒ½å°†æ•°æ®åº“è®°å½•å°è£…æˆpojoå¯¹è±¡è§£ææ¯”è¾ƒæ–¹ä¾¿ã€‚

### 1.2  åŸå§‹JDBCå¼€å‘å­˜åœ¨é—®é¢˜è§£å†³æ–¹æ¡ˆ

![img](https://cdn.jsdelivr.net/gh/EayonLee/IMG-Cloud@master/data/javagodæˆç¥ä¹‹è·¯.png)



## äºŒ. è‡ªå®šä¹‰æŒä¹…å±‚æ¡†æ¶è®¾è®¡æ€è·¯

> ä»¥ä¸‹æ‰€æœ‰ä½¿ç”¨åˆ°çš„æ–‡ä»¶åã€ç±»åæˆ–å˜é‡åç­‰éƒ½æ˜¯æˆ‘è‡ªå®šä¹‰çš„ï¼Œå¦‚æœå’ŒMyBatisé›·åŒçº¯å±å·§åˆï¼ˆå“ˆå“ˆå“ˆï¼‰ï¼Œå¤§å®¶ä¹Ÿå¯ä»¥éšä¾¿å®šä¹‰ã€‚

### 2.1 å®¢æˆ·ç«¯

**å•¥æ˜¯å®¢æˆ·ç«¯ï¼Ÿ**ï¼šå¯ç†è§£ä¸ºæ˜¯ä¸€ä¸ªä½¿ç”¨æˆ‘ä»¬è‡ªå®šä¹‰æŒä¹…å±‚æ¡†æ¶çš„é¡¹ç›®ã€‚

â€‹	æŒ‰ç…§æˆ‘ä»¬åŸæ¥ä½¿ç”¨Mybatisçš„ç»éªŒï¼Œæˆ‘ä»¬çŸ¥é“å®¢æˆ·ç«¯éœ€è¦æä¾›ä¸¤ä¸ªæ ¸å¿ƒé…ç½®ä¿¡æ¯ï¼šæ•°æ®åº“é…ç½®ä¿¡æ¯ã€SQLé…ç½®ä¿¡æ¯ã€‚

â€‹	è€Œä¸”æ ¹æ®ä¸Šé¢æˆ‘ä»¬åˆ†æJDBCçš„ç¼ºé™·æ—¶ï¼Œæ•°æ®åº“é…ç½®ä¿¡æ¯å’ŒSQLé…ç½®ä¿¡æ¯éƒ½æ˜¯å†™æ­»åœ¨ä»£ç ä¸­çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬è‡ªå®šä¹‰çš„æ—¶å€™è‚¯å®šä¸èƒ½å†™æ­»åœ¨ä»£ç é‡Œï¼Œæˆ‘ä»¬éœ€è¦å†™åœ¨é…ç½®æ–‡ä»¶ä¸­ã€‚

#### ï¼ˆ1ï¼‰æä¾›é…ç½®æ–‡ä»¶ä¾›æŒä¹…å±‚æ¡†æ¶è¯»å–ï¼š

* **sqlMapConfig.xml**ï¼šå­˜æ”¾æ•°æ®åº“é…ç½®ä¿¡æ¯

* **mapper.xml**ï¼šSQLé…ç½®ä¿¡æ¯ï¼šSQLè¯­å¥ã€å‚æ•°ç±»å‹ã€è¿”å›å€¼ç±»å‹



### 2.2 è‡ªå®šä¹‰æŒä¹…å±‚æ¡†æ¶ç«¯

**å•¥æ˜¯è‡ªå®šä¹‰æŒä¹…å±‚æ¡†æ¶ç«¯ï¼Ÿ**ï¼šå…¶å®å°±æ˜¯å¯¹JDBCå°è£…çš„ä¸€ä¸ªå·¥å‚ï¼Œä¾›å®¢æˆ·ç«¯ä½¿ç”¨ã€‚

â€‹	æˆ‘ä»¬çŸ¥é“è‡ªå®šä¹‰æŒä¹…å±‚æ¡†æ¶å…¶å®æœ¬è´¨æ˜¯å¯¹JDBCä»£ç è¿›è¡Œå°è£…ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦åšä»¥ä¸‹ä¸€äº›å·¥ä½œï¼š

#### ï¼ˆ1ï¼‰è¯»å–å®¢æˆ·ç«¯æä¾›çš„é…ç½®æ–‡ä»¶ï¼š

* åˆ›å»º``Resources``ç±»ï¼Œå¹¶å®šä¹‰``getResourcesAsStream(String path)``æ–¹æ³•å°†é…ç½®æ–‡ä»¶è¯»å–æˆå­—èŠ‚æµå­˜å‚¨ä¸å†…å­˜ä¸­å¹¶è¿”å›ã€‚

  **æ€è€ƒ**ï¼šæˆ‘ä»¬ç°åœ¨å¯ä»¥ç”¨``getResourceAsStream()``æ–¹æ³•å»åŠ è½½é…ç½®æ–‡ä»¶ï¼Œä½†æ˜¯å®¢æˆ·ç«¯æœ‰ä¸¤ä¸ªé…ç½®æ–‡ä»¶éš¾é“æˆ‘ä»¬å°±è¦å»åŠ è½½ä¸¤æ¬¡å—ï¼Ÿ

  â€‹			å…¶å®æˆ‘ä»¬å¯ä»¥å°†``*mapper.xml``é…ç½®æ–‡ä»¶çš„å…¨è·¯å¾„å­˜æ”¾äº``sqlMapConfig.xml``ä¸­ï¼Œè¿™æ ·æˆ‘ä»¬åªéœ€è¦åŠ è½½ä¸€æ¬¡``sqlMapConfig.xmlå°±			å¯ä»¥å…¨éƒ¨è·å–äº†ã€‚

#### ï¼ˆ2ï¼‰åˆ›å»ºä¸¤ä¸ªå®¹å™¨å¯¹è±¡ï¼š

â€‹		ä»ç¬¬ä¸€æ­¥æ¥çœ‹ï¼Œæˆ‘ä»¬åªæ˜¯å°†é…ç½®æ–‡ä»¶è¯»å–åˆ°äº†å†…å­˜ä¸­ï¼Œè€Œå†…å­˜ä¸­çš„æ•°æ®æˆ‘ä»¬æ˜¯ä¸æ˜¯ä¸æ–¹ä¾¿æ“ä½œï¼Ÿæ‰€ä»¥æˆ‘ä»¬è¦åŸºäºJavaé¢å‘å¯¹è±¡çš„æ€	æƒ³ï¼Œå°†è¿™ä¸¤ä¸ªé…ç½®æ–‡ä»¶è§£	æä¸º	ä¸¤ä¸ªJava Beanï¼š``Configuration`` ã€``MappedStatement``

* **Configurationï¼ˆæ ¸å¿ƒé…ç½®ç±»ï¼‰**: å­˜æ”¾æ•°æ®åº“åŸºæœ¬ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯å®¢æˆ·ç«¯æä¾›çš„``sqlMapConfig.xml``é…ç½®æ–‡ä»¶çš„å†…å®¹

* **MappedStatementï¼ˆæ˜ å°„é…ç½®ç±»ï¼‰**ï¼šå­˜æ”¾SQLè¯­å¥ã€å‚æ•°ç±»å‹ã€è¿”å›å€¼ç±»å‹ï¼Œä¹Ÿå°±æ˜¯å­˜æ”¾``*mapper.xml``é…ç½®æ–‡ä»¶çš„å†…å®¹

#### ï¼ˆ3ï¼‰è§£æé…ç½®æ–‡ä»¶ï¼š

* åˆ›å»º``XMLConfigBuilder``ç±»å¹¶å®šä¹‰``parseConfig(InputStream is)``æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä½¿ç”¨``dom4j``å°†``sqlMapConfig.xml``åœ¨å†…å­˜ä¸­çš„å­—èŠ‚æµå°è£…åˆ°``Configuration``é…ç½®å®ä½“å¹¶è¿”å›ã€‚

* åˆ›å»º``XMLMapperBuilder``ç±»å¹¶å®šä¹‰``parse(InputStream is)``æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä½¿ç”¨``dom4j``å°†``*mapper.xml``åœ¨å†…å­˜ä¸­çš„å­—èŠ‚æµå°è£…åˆ°``MappedStatement``é…ç½®å®ä½“ï¼Œå¹¶å°†è¯¥å®ä½“èµ‹å€¼ç»™``Configuration``ä¸­çš„å±æ€§ã€‚

- åˆ›å»ºä¸€ä¸ªæ„å»ºè€…ç±»SqlSessionFactoryBuilderï¼Œç±»ä¸­æœ‰ä¸ªæ–¹æ³•ï¼šbuild(InputStream is)ï¼Œé‚£buildä¸­çš„å‚æ•°ä¹Ÿå°±æ˜¯å†…å­˜ä¸­å®¢æˆ·ç«¯æä¾›çš„sqlMapConfig.xmlæ–‡ä»¶æµã€‚SqlSessionFactoryBuilderä¼šé€šè¿‡é…ç½®æ–‡ä»¶åˆ›å»ºä¸€ä¸ªSqlSessionFactoryå·¥å‚ï¼Œé€šè¿‡sessionå·¥å‚ç”Ÿäº§sessionã€‚

#### ï¼ˆ4ï¼‰åˆ›å»ºSqlSessionFactoryæ¥å£åŠå®ç°ç±»DefaultSqlSessionFactoryï¼š

- åˆ›å»º``SqlSessionFactory``æ¥å£åŠå®ç°ç±»``DefaultSqlSessionFactory``Sessionå·¥å‚ï¼Œå¹¶æä¾›ä¸€ä¸ªopenSession() æ–¹æ³•æ¥ç”Ÿäº§sqlSessionï¼ˆä¼šè¯å¯¹è±¡ï¼‰ï¼Œé‚£å…¶å®æˆ‘ä»¬å¯¹æ•°æ®çš„å¢åˆ æ”¹æŸ¥æ–¹æ³•éƒ½å°è£…åœ¨sqlSessionä¸­ã€‚

#### ï¼ˆ5ï¼‰åˆ›å»ºSqlSessionæ¥å£åŠå®ç°ç±»DefaultSqlSessionï¼š

â€‹	``SqlSession``ä¸»è¦å°è£…äº†ä¸€äº›å¯¹æ•°æ®åº“CRUDï¼ˆå¢åˆ æ”¹æŸ¥ï¼‰æ“ä½œçš„æ–¹æ³•

- æä¾›``selectList()``æ–¹æ³•ï¼šæŸ¥è¯¢æ‰€æœ‰æ•°æ®
- æä¾›``selectOne()``ï¼šæŸ¥è¯¢å•ä¸ª
- æä¾›``update()``ï¼šä¿®æ”¹
- æä¾›``delete()``ï¼šåˆ é™¤

#### ï¼ˆ6ï¼‰åˆ›å»ºExecutoræ¥å£åŠå®ç°ç±»SimpleExecutorï¼š

- åˆ›å»ºExecutoræ¥å£åŠå®ç°ç±»SimpleExecutorå¹¶æä¾›``query(Configuration c, MappedStatement m, Object...param)``æ–¹æ³•ï¼Œç”¨äºæ‰§è¡Œå°è£…çš„jdbcä»£ç 

  **è§£é‡Š**ï¼šæœ¬æ­¥æ“ä½œå…¶å®å°±æ˜¯å°†jdbcçš„å¢åˆ æ”¹æŸ¥æ–¹æ³•å°è£…åˆ°``Executor``æ¥å£åŠå®ç°ç±»``SimpleExcutor``æ¥åšè¿›ä¸€æ­¥çš„å°è£…ï¼Œè¿™ä¸ªqeuryæ–¹æ³•å…¶å®å°±æ˜¯å¯¹jdbcåŸå§‹æŸ¥è¯¢æ“ä½œçš„å°è£…ã€‚å‚æ•°åˆ†åˆ«ä¸ºï¼šæ ¸å¿ƒé…ç½®æ–‡ä»¶ã€*mapperæ˜ å°„æ–‡ä»¶ã€æŸ¥è¯¢å‚æ•°ã€‚é‚£ä¹ˆæ¯”å¦‚ä½¿ç”¨``DefaultSqlSession``ä¸­``selectList()``æ–¹æ³•è°ƒç”¨çš„ä¹Ÿå°±æ˜¯``SimpleExcutor``ä¸­å°è£…çš„``query()``æ–¹æ³•ã€‚

#### ï¼ˆ7ï¼‰åˆ›å»ºSqlSessionFactoryBuilderï¼š

- åˆ›å»º``SqlSessionFactoryBuilder``ç±»ï¼Œå¹¶å®šä¹‰``build(InputStream is)``æ–¹æ³•ï¼Œ``build``ä¸­çš„å‚æ•°ä¹Ÿå°±æ˜¯``sqlMapConfig.xml``æ–‡ä»¶æµã€‚

- ``build()``ä¸­ä¼šè°ƒç”¨``XMLConfigBuilder.parseConfig(inputStream)``æ–¹æ³•å°†æ–‡ä»¶æµä½¿ç”¨``dom4j``è§£ææˆ``Configuration``å¯¹è±¡ã€‚

- ç„¶åé€šè¿‡``Configuration``é…ç½®å®ä½“ä½œä¸ºå‚æ•°æ„å»ºDefaultSqlSessionFactoryå·¥å‚å¹¶è¿”å›ã€‚

  **è§£é‡Š**ï¼šå½“å®¢æˆ·ç«¯ä½¿ç”¨``Resources.getResourceAsStream(sqlmapConfig.xml)``è·å–åˆ°é…ç½®æ–‡ä»¶å­—èŠ‚æµåï¼Œé€šè¿‡``SqlSessionFactoryBuilder.build(resourceAsStream)``æ–¹æ³•å°†å­—èŠ‚æµæ„å»ºæˆ``SqlSessionFactory``å·¥å‚ã€‚æ‰€ä»¥``SqlSessionFactory``ä¸­åŒ…å«äº†å®¢æˆ·ç«¯æä¾›çš„é…ç½®ä¿¡æ¯ã€‚ç„¶åå®¢æˆ·ç«¯å†é€šè¿‡``SqlSessionFactory.openSession()``æ–¹æ³•å»ç”Ÿäº§``SqlSession``ï¼Œé‚£è¿™ä¸ªæ—¶å€™SqlSessionä¸­ä¹ŸåŒ…å«é…ç½®ä¿¡æ¯ã€‚é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡``SqlSession``ä¸­çš„CRUDæ–¹æ³•ï¼Œå°†é…ç½®ä¿¡æ¯åœ¨ç»™åˆ°``SimpleExecutor``ä¸­å…·ä½“çš„JDBCä»£ç ä¸­å®ç°å®Œæ•´çš„ä¸€å¥—æµç¨‹ã€‚

  

### 2.3 æ‰§è¡Œæµç¨‹å›¾

![image-20210301162130434](https://cdn.jsdelivr.net/gh/EayonLee/IMG-Cloud@master/data/image-20210301162130434.png)



## ä¸‰. è‡ªå®šä¹‰æŒä¹…å±‚æ¡†æ¶å®ç°

> æºç åœ°å€ï¼š[é£æœºç¥¨âœˆ](https://github.com/EayonLee/JavaGod/tree/main/1%E9%98%B6%E6%AE%B5%EF%BC%9A%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/01%E6%A8%A1%E5%9D%97%EF%BC%9A%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8C%81%E4%B9%85%E5%B1%82%E6%A1%86%E6%9E%B6%E8%AE%BE%E8%AE%A1%E5%8F%8AMyBatis%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/01.%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8C%81%E4%B9%85%E5%B1%82%E6%A1%86%E6%9E%B6/01.%E8%AF%BE%E7%A8%8B%E8%B5%84%E6%96%99)

### 3.1 è¯»å–é…ç½®æ–‡ä»¶

**è‡ªå®šä¹‰æŒä¹…å±‚æ¡†æ¶ç«¯**

* **ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºè‡ªå®šä¹‰æŒä¹…å±‚æ¡†æ¶é¡¹ç›®ï¼Œé¡¹ç›®åï¼š``Ipersistence``**

* **ç¬¬äºŒæ­¥ï¼šæ·»åŠ pomåæ ‡**

  ```xml
  <dependencies>
      <!--mysql-->
      <dependency>
          <groupId>mysql</groupId>
          <artifactId>mysql-connector-java</artifactId>
          <version>5.1.17</version>
      </dependency>
      <!--dom4j-->
      <dependency>
          <groupId>dom4j</groupId>
          <artifactId>dom4j</artifactId>
          <version>1.6.1</version>
      </dependency>
      <!--c3p0-->
      <dependency>
          <groupId>c3p0</groupId>
          <artifactId>c3p0</artifactId>
          <version>0.9.1.2</version>
      </dependency>
      <!--junit-->
      <dependency>
          <groupId>junit</groupId>
          <artifactId>junit</artifactId>
          <version>4.10</version>
      </dependency>
      <!--jaxen-->
      <dependency>
          <groupId>jaxen</groupId>
          <artifactId>jaxen</artifactId>
          <version>1.1.6</version>
      </dependency>
  </dependencies>
  ```

* **ç¬¬ä¸‰æ­¥ï¼šåˆ›å»ºResourcesç±»ï¼Œç”¨äºè¯»å–å®¢æˆ·ç«¯æä¾›çš„é…ç½®æ–‡ä»¶**

  > åœ¨``com.eayon.io``ç›®å½•ä¸‹åˆ›å»º``Resources``ç±»ï¼Œç±»ä¸­å®šä¹‰``getResourceAsStream(String path)``æ–¹æ³•å»åŠ è½½é…ç½®æ–‡ä»¶ï¼Œæ–¹æ³•è¿”å›å€¼``InputStream``

  ```java
  package com.eayon.io;
  
  import java.io.InputStream;
  
  /**
   * æ ¹æ®å®¢æˆ·ç«¯çš„é…ç½®æ–‡ä»¶è·¯å¾„å°†é…ç½®æ–‡ä»¶è¯»å–æˆå­—èŠ‚è¾“å…¥æµçš„å½¢å¼å­˜å‚¨äºå†…å­˜ä¸­
   */
  public class Resources {
  
      /**
       * å¯å°†æ–‡ä»¶è¯»å–æˆå­—èŠ‚æµçš„å½¢å¼å­˜å‚¨äºå†…å­˜å¹¶è¿”å›
       *
       * @param path é…ç½®æ–‡ä»¶è·¯å¾„
       * @return
       */
      public static InputStream getResourceAsStream(String path) {
          InputStream resourceAsStream = Resources.class.getClassLoader().getResourceAsStream(path);
          return resourceAsStream;
      }
  
  }
  ```

* **ç¬¬å››æ­¥ï¼šå°†è‡ªå®šä¹‰æŒä¹…å±‚æ¡†æ¶é¡¹ç›®æ‰“åŒ…è‡³æœ¬åœ°Mavenä»“åº“**



**å®¢æˆ·ç«¯**

* **ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºå®¢æˆ·ç«¯é¡¹ç›®ï¼Œé¡¹ç›®åï¼š``Ipersistence_test``**

* **ç¬¬äºŒæ­¥ï¼šåˆ›å»ºæ•°æ®åº“æ ¸å¿ƒé…ç½®æ–‡ä»¶ï¼šSqlMapConfig.xml**

  åœ¨``resources``ç›®å½•ä¸‹åˆ›å»ºå¦‚ä¸‹``SqlMapConfig.xml``æ ¸å¿ƒé…ç½®æ–‡ä»¶

  ```xml
  <!--æ•°æ®åº“æ ¸å¿ƒé…ç½®æ–‡ä»¶-->
  <configuration>
  
      <!--æ•°æ®æºé…ç½®ä¿¡æ¯-->
      <dataSource>
          <property name="driverClass" value="com.mysql.jdbc.Driver"></property><!--Mysqlæ•°æ®åº“é©±åŠ¨-->
          <property name="jdbcUrl" value="jdbc:mysql:///eayon_mybatis"></property><!--è¿æ¥çš„æ•°æ®åº“åœ°å€  æ•°æ®åº“è‡ªè¡Œåˆ›å»º-->
          <property name="username" value="root"></property><!--æ•°æ®åº“è´¦å·-->
          <property name="password" value="1234"></property><!--æ•°æ®åº“å¯†ç -->
      </dataSource>
  
      <!--å­˜æ”¾ *mapper.xmlçš„å…¨è·¯å¾„-->
      <mapper resource="UserMapper.xml"></mapper>
  </configuration>
  ```

* **ç¬¬ä¸‰æ­¥ï¼šåˆ›å»ºMapperæ˜ å°„é…ç½®æ–‡ä»¶**

  åœ¨``resources``ç›®å½•ä¸‹åˆ›å»ºå¦‚ä¸‹``UserMapper.xml``é…ç½®æ–‡ä»¶

  ```xml
  <!-- namespaceï¼šå½“å‰UserMapper.xmlçš„å”¯ä¸€æ ‡è¯†-->
  <mapper namespace="user">
  
      <!--æŸ¥è¯¢æ‰€æœ‰-->
      <!-- idï¼šå½“å‰selectæ ‡ç­¾çš„å”¯ä¸€æ ‡è¯†-->
      <!--æƒ³è¦ç²¾å‡†å®šä½åˆ°å½“å‰è¿™æ¡SQLè¯­å¥ï¼šæ˜¯é€šè¿‡ namespaceå’Œè¯¥æ¡selectæ ‡ç­¾ä¸­çš„idæ¥ç»„æˆä¸€ä¸ªstatementIdæ¥è¿›è¡Œå®šä½çš„ ï¼Œ å¦‚è¯¥æ¡SQLçš„statementIdä¸º user.selectList-->
      <!--resultTypeï¼šè¯¥æ¡SQLè¯­å¥è¿”å›ç»“æœçš„è¿”å›å€¼ç±»å‹-->
      <select id="selectList" restType="com.eayon.pojo.User">
          select * from user
      </select>
  
      <!--æ¡ä»¶æŸ¥è¯¢-->
      <!--paramterTypeï¼šå‚æ•°ç±»å‹-->
      <select id="selectOne" restType="com.eayon.pojo.User"  paramterType="com.eayon.pojo.User">
          select * from user where id = #{id} and username = #{username}
      </select>
  
  </mapper>
  ```

* **ç¬¬å››æ­¥ï¼šæ·»åŠ pomåæ ‡ï¼ˆè‡ªå®šä¹‰æŒä¹…å±‚æ¡†æ¶æ‰“åŒ…åçš„åæ ‡ï¼‰**

  ```xml
  <!--å¼•å…¥è‡ªå®šä¹‰æŒä¹…å±‚æ¡†æ¶çš„ä¾èµ–-->
      <dependencies>
          <dependency>
              <groupId>com.eayon</groupId>
              <artifactId>Ipersistence</artifactId>
              <version>1.0-SNAPSHOT</version>
          </dependency>
      </dependencies>
  ```

* **ç¬¬äº”æ­¥ï¼šæµ‹è¯•è¯»å–SqlMapConfig.xmlé…ç½®æ–‡ä»¶**

  åœ¨``com.eayon.test``ä¸‹åˆ›å»º``MyTest``ç±»å¹¶æµ‹è¯•æ˜¯å¦å¯ä»¥è¯»å–æˆåŠŸ

  ```java
  package com.eayon.test;
  
  import com.eayon.io.Resources;
  
  import java.io.InputStream;
  
  /**
   * æµ‹è¯•ç±»
   */
  public class MyTest {
  
      public static void main(String[] args) {
          InputStream resourceAsStream = Resources.getResourceAsStream("sqlMapConfig.xml");
          System.out.println(resourceAsStream);
      }
  }
  ```



### 3.2 å®¹å™¨å¯¹è±¡å®šä¹‰

**è‡ªå®šä¹‰æŒä¹…å±‚æ¡†æ¶ç«¯**

* **ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºMappedStatementå®¹å™¨å¯¹è±¡**

  åœ¨``com.eayon.pojo``ä¸‹åˆ›å»º``MappedStatement``å®¹å™¨å¯¹è±¡

  > æ¯”å¦‚``UserMapper.xml``ä¸­æœ‰ä¸¤ä¸ª``select``æ ‡ç­¾ï¼Œé‚£ä¹ˆåŠ è½½``UserMapper.xml``çš„æ—¶å€™å°±ä¼šäº§ç”Ÿä¸¤ä¸ª``MappedStatement``å®¹å™¨å¯¹è±¡ã€‚

  ```java
  package com.eayon.pojo;
  
  /**
   * æ˜ å°„é…ç½®ç±»ï¼šå­˜æ”¾SQLè¯­å¥ã€å‚æ•°ç±»å‹ã€è¿”å›å€¼ç±»å‹ï¼Œä¹Ÿå°±æ˜¯*mapper.xmlé…ç½®æ–‡ä»¶ä¸­æ¯ä¸€ä¸ªæŒä¹…åŒ–æ“ä½œæ ‡ç­¾çš„å†…å®¹ï¼Œå¦‚æŸä¸€ä¸ªselectæ ‡ç­¾
   * ä¸€ä¸ª*mapper.xmlé…ç½®æ–‡ä»¶å¯èƒ½ä¼šè§£æå‡ºæ¥å¤šä¸ªMappedStatement
   */
  public class MappedStatement {
  
      //idæ ‡è¯†
      private String id;
      //è¿”å›å€¼ç±»å‹
      private String resultType;
      //å‚æ•°å€¼ç±»å‹
      private String paramterType;
      //sqlè¯­å¥
      private String sql;
  
      public String getId() {
          return id;
      }
  
      public void setId(String id) {
          this.id = id;
      }
  
      public String getResultType() {
          return resultType;
      }
  
      public void setResultType(String resultType) {
          this.resultType = resultType;
      }
  
      public String getParamterType() {
          return paramterType;
      }
  
      public void setParamterType(String paramterType) {
          this.paramterType = paramterType;
      }
  
      public String getSql() {
          return sql;
      }
  
      public void setSql(String sql) {
          this.sql = sql;
      }
  }
  ```

* **ç¬¬äºŒæ­¥ï¼šåˆ›å»ºConfigurationå®¹å™¨å¯¹è±¡**

  åœ¨``com.eayon.pojo``ä¸‹åˆ›å»º``Configuration``æ ¸å¿ƒé…ç½®ç±»

  > æˆ‘ä»¬åœ¨ä½¿ç”¨``dom4j``åŠ è½½``sqlMapConfig.xml``æ ¸å¿ƒé…ç½®æ–‡ä»¶æ—¶å°±å°†``dataSource``è¿™ä¸ªæ ‡ç­¾ä¸­çš„å±æ€§å€¼è§£æå¹¶åˆ›å»ºæˆæ•°æ®æºå¯¹è±¡èµ‹å€¼åˆ°è¯¥``Configuration``æ ¸å¿ƒé…ç½®ç±»çš„``dataSource``å±æ€§ä¸­
  >
  > è€Œä¸”åœ¨ä¹‹å‰æˆ‘ä»¬æåˆ°``sqlMapConfig.xml``ä¸­é…ç½®äº†`` *mapper.xml``çš„å…¨è·¯å¾„ï¼Œæ‰€ä»¥è§£æçš„æ—¶å€™åŒæ ·ä¼šè§£æåˆ° ``*mapper.xml``ï¼Œæ¯”å¦‚``Usermapper.xml``ä¸­å­˜åœ¨å¤šä¸ªæŒä¹…åŒ–æ ‡ç­¾å°±ä¼šåˆ›å»ºå¤šä¸ª``MappedStatement``å®¹å™¨å¯¹è±¡ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç”¨Mapé›†åˆæ¥å­˜æ”¾è¿™å¤šä¸ª``MappedStatement``ã€‚

  Mapé›†åˆçš„Keyï¼š ``statementId``  (namespace.id)ï¼Œé€šè¿‡``statementId``å¯ä»¥å®šä½åˆ°æ¯ä¸€æ¡SQL

  Mapé›†åˆä¸­çš„Valueï¼šæ¯æ¡SQLçš„é…ç½®ç±»``MappedStatement``

  ```java
  package com.eayon.pojo;
  
  import javax.sql.DataSource;
  import java.util.HashMap;
  import java.util.Map;
  
  /**
   * æ ¸å¿ƒé…ç½®ç±»ï¼šå­˜æ”¾æ•°æ®åº“åŸºæœ¬ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯å®¢æˆ·ç«¯æä¾›çš„sqlMapConfig.xmlé…ç½®æ–‡ä»¶çš„å†…å®¹
   */
  public class Configuration {
  
      //æ•°æ®æºé…ç½®ä¿¡æ¯ï¼šä½¿ç”¨dom4jè§£æsqlMapConfig.xmlæ—¶ä¼šè§£æåˆ°dataSourceè¿™ä¸ªæ ‡ç­¾ä¸­çš„å±æ€§å€¼å¹¶åˆ›å»ºæˆæ•°æ®æºå¯¹è±¡èµ‹å€¼ç»™æœ¬ç±»çš„dataSourceå±æ€§
      private DataSource dataSource;
  
      //åœ¨sqlMapConfig.xmlä¸­ä¼šå­˜æ”¾*mapper.xmlçš„å…¨è·¯å¾„å¹¶åŠ è½½
      //é‚£ä¸€ä¸ª*mapper.xmlå¯èƒ½ä¼šè§£æå‡ºæ¥å¤šä¸ªMappedStatement(SQLé…ç½®ä¿¡æ¯)ï¼Œæ‰€ä»¥åœ¨Configurationæˆ‘ä»¬ä½¿ç”¨Mapæ¥è¿›è¡Œå¤šä¸ªå­˜å‚¨
      //Mapé›†åˆä¸­çš„Keyï¼šstatementIdï¼ˆnamespace.idï¼‰ï¼Œé€šè¿‡statementIdå¯ä»¥å®šä½åˆ°æ¯ä¸€æ¡SQLï¼ŒstatementIdæ˜¯ç”±mapper.xmlé…ç½®æ–‡ä»¶ä¸­çš„namespace + "." + id ç»„æˆçš„
      //Mapé›†åˆä¸­çš„Valueï¼šæ¯æ¡SQLçš„é…ç½®ç±»MappedStatement
      Map<String, MappedStatement> mappedStatementMap = new HashMap<>();
  
      public DataSource getDataSource() {
          return dataSource;
      }
  
      public void setDataSource(DataSource dataSource) {
          this.dataSource = dataSource;
      }
  
      public Map<String, MappedStatement> getMappedStatementMap() {
          return mappedStatementMap;
      }
  
      public void setMappedStatementMap(Map<String, MappedStatement> mappedStatementMap) {
          this.mappedStatementMap = mappedStatementMap;
      }
  }
  ```



### 3.3 è§£ææ ¸å¿ƒé…ç½®æ–‡ä»¶

**è‡ªå®šä¹‰æŒä¹…å±‚æ¡†æ¶ç«¯**

> æˆ‘ä»¬å›æƒ³ä¸€ä¸‹ï¼Œæ˜¯ä¸æ˜¯å®¢æˆ·ç«¯é€šè¿‡è‡ªå®šä¹‰æ¡†æ¶çš„``Resources.getResourceAsStream()``æ–¹æ³•æŠŠé…ç½®æ–‡ä»¶è¯»å–æˆå­—èŠ‚æµåï¼Œéœ€è¦é€šè¿‡``SqlSessionFactoryBuilder``çš„``Builder``æ–¹æ³•ï¼Œæ ¹æ®é…ç½®æ–‡ä»¶å­—èŠ‚æµè·å–``SqlSessionFactory``å·¥å‚ï¼Ÿé€šè¿‡``SqlSessionFactory``å»åˆ›å»º``session``ï¼Ÿå†é€šè¿‡``session``å¯¹æ•°æ®åº“è¿›è¡Œæ“ä½œï¼Ÿé‚£æˆ‘ä»¬å°±åƒæ¥åˆ›å»º``SqlSessionFactoryBuilder``ï¼

* **ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºSqlSessionFactoryBuilder**

  åœ¨``com.eayon.sqlSession``ä¸‹åˆ›å»º``SqlSessionFactoryBuilder``ç±»ï¼Œå¹¶å®šä¹‰``build(InputStream is)æ–¹æ³•

  ``build``æ–¹æ³•ä¸­å…·ä½“è¿›è¡Œä¸¤æ­¥æ“ä½œï¼šï¼ˆæš‚ä¸ç¼–å†™å…·ä½“æ“ä½œå†…å®¹ï¼‰

  â€‹		1) ï¼šä½¿ç”¨``dom4j``è§£æé…ç½®æ–‡ä»¶ï¼Œå°†è§£æå‡ºæ¥çš„å†…å®¹å°è£…åˆ°``Configuration``æ ¸å¿ƒé…ç½®ç±»ä¸­

  â€‹		2) ï¼šåˆ›å»º``SqlSessionFactory``å¯¹è±¡å¹¶è¿”å›

  ```java
  package com.eayon.sqlSession;
  
  
  import java.io.InputStream;
  
  /**
   * æ„å»ºè€…ç±»ï¼šç”¨äºåˆ›å»ºSqlSessionFactory
   */
  public class SqlSessionFactoryBuilder {
  
      public SqlsessionFactory build(InputStream is){
          //ç¬¬ä¸€ï¼šä½¿ç”¨dom4jè§£æé…ç½®æ–‡ä»¶ï¼Œå°†è§£æå‡ºæ¥çš„å†…å®¹å°è£…åˆ°Configurationä¸­
  
  
          //ç¬¬äºŒï¼šåˆ›å»ºSqlsessionFactoryå·¥å‚
  
          return null;
      }
  }
  ```

  > ``SqlSessionFactory``æˆ‘ä»¬è¿˜æ²¡æœ‰åˆ›å»ºï¼Œä¼šæŠ¥çº¢ï¼Œæˆ‘ä»¬å…ˆä¸ç®¡ä»–ã€‚

  æˆ‘ä»¬å…ˆæ¥åˆ†æä»£ç ä¸­çš„ç¬¬ä¸€æ­¥ï¼šå¦‚ä½•é€šè¿‡dom4jè§£ææ–‡ä»¶æµå°è£…åˆ°``Configurationä¸­``ï¼Ÿ

  è¿™å°±éœ€è¦åˆ›å»º``XMLConfigBuilder``ç±»æ¥æä¾›è§£æå°è£…çš„æ–¹æ³•ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¿›å…¥ä¸‹ä¸€æ­¥

* **ç¬¬äºŒæ­¥ï¼šåˆ›å»ºXMLConfigBuilderæ¥è§£æSqlMapConfig.xml**

  åœ¨``com.eayon.config``ä¸‹åˆ›å»º``XMLConfigBuilder``å¹¶æä¾›``parseConfig``æ–¹æ³•

  ``parseConfig``æ–¹æ³•åˆ†ä¸ºä¸¤æ­¥ï¼š

  â€‹		1) ï¼šä½¿ç”¨``dom4j``è§£æé…ç½®æ–‡ä»¶ï¼Œå°†è§£æå‡ºæ¥çš„å†…å®¹å°è£…åˆ°``Configuration``æ ¸å¿ƒé…ç½®ç±»ä¸­

  â€‹		2) ï¼šåˆ›å»º``SqlMapConfig.xml``ä¸­é…ç½®çš„``*mapper.xml``çš„å…¨è·¯å¾„æ¥è§£æ``*mapper.xml``é…ç½®æ–‡ä»¶å¹¶å°è£…åˆ°``MappedStatement``é…ç½®ç±»ï¼Œ				å†å°†MappedStatementèµ‹å€¼ç»™Configurationçš„mappedStatementMapå±æ€§ã€‚

  > æœ¬æ­¥éª¤åªå®Œæˆç¬¬ä¸€æ­¥ï¼Œç¬¬äºŒæ­¥è§£æ``*mapper.xml``è¯·å¾€ä¸‹ä¸€æ­¥ç»§ç»­çœ‹

  ```java
  package com.eayon.config;
  
  import com.eayon.pojo.Configuration;
  import com.mchange.v2.c3p0.ComboPooledDataSource;
  import org.dom4j.Document;
  import org.dom4j.DocumentException;
  import org.dom4j.Element;
  import org.dom4j.io.SAXReader;
  
  import java.beans.PropertyVetoException;
  import java.io.InputStream;
  import java.util.List;
  import java.util.Properties;
  
  /**
   * ä½¿ç”¨dom4jè§£æsqlMapConfig.xmlçš„å­—èŠ‚æµå°è£…åˆ°Configurationæ ¸å¿ƒé…ç½®ç±»
   */
  public class XMLConfigBuilder {
  
      //å£°æ˜æ ¸å¿ƒé…ç½®ç±»æˆå‘˜å˜é‡
      private Configuration configuration;
  
      //åœ¨new XMLConfigBuilderçš„æ—¶å€™å°±ä¼šé€šè¿‡æ— å‚æ„é€ ç»™æˆå‘˜å˜é‡configurationè¿›è¡Œèµ‹å€¼
      public XMLConfigBuilder() {
          this.configuration = new Configuration();
      }
  
      /**
       * è¯¥æ–¹æ³•ä½¿ç”¨dom4jå°†sqlMapConfig.xmlåœ¨å†…å­˜ä¸­çš„å­—èŠ‚æµå°è£…åˆ°Configurationæ ¸å¿ƒé…ç½®ç±»å¹¶è¿”å›ã€‚
       *
       * @param is æ ¸å¿ƒé…ç½®æ–‡ä»¶qlMapConfig.xmlçš„å­—èŠ‚æµ
       * @return
       */
      public Configuration parseConfig(InputStream is) throws DocumentException, PropertyVetoException {
  
          /**
           * ç¬¬ä¸€æ­¥ï¼šé€šè¿‡dom4jè§£ææ ¸å¿ƒé…ç½®æ–‡ä»¶å°è£…åˆ°Configurationé…ç½®ç±»
           */
          //é€šè¿‡dom4jè¯»å–æ ¸å¿ƒé…ç½®æ–‡ä»¶å­—èŠ‚æµç”ŸæˆDom
          Document document = new SAXReader().read(is);
          //æ‹¿åˆ°æ ¹å…ƒç´ ï¼Œä¹Ÿå°±æ˜¯sqlMapConfig.xmlæ–‡ä»¶ä¸­çš„configurationæ ‡ç­¾
          Element configElement = document.getRootElement();
          //æŸ¥æ‰¾æ ¹å…ƒç´ ä¸‹æ‰€æœ‰çš„propertyæ ‡ç­¾å…ƒç´ 
          List<Element> propertyElements = configElement.selectNodes("//property");
          //é€šè¿‡Propertieså­˜å‚¨æ•°æ®æºä¿¡æ¯nameä»¥åŠvalueå€¼
          Properties dataSources = new Properties();
          //è·å–æ¯ä¸€ä¸ªpropertyå…ƒç´ çš„nameä»¥åŠvalueå€¼
          for (Element propertyElement : propertyElements) {
              String name = propertyElement.attributeValue("name");
              String value = propertyElement.attributeValue("value");
              //å°†nameã€valueå¯¹åº”çš„å­˜å…¥Properties
              dataSources.setProperty(name,value);
          }
  
          //åˆ›å»ºæ•°æ®åº“è¿æ¥æ± 
          ComboPooledDataSource comboPooledDataSource = new ComboPooledDataSource();
          //è®¾ç½®æ•°æ®æºä¿¡æ¯
          comboPooledDataSource.setDriverClass(dataSources.getProperty("driverClass"));
          comboPooledDataSource.setJdbcUrl(dataSources.getProperty("jdbcUrl"));
          comboPooledDataSource.setUser(dataSources.getProperty("username"));
          comboPooledDataSource.setPassword(dataSources.getProperty("password"));
  
          //å°†æ•°æ®æºå°è£…åˆ°Configurationå¯¹è±¡
          configuration.setDataSource(comboPooledDataSource);
  
          /**
           * ç¬¬äºŒæ­¥ï¼šé€šè¿‡sqlMapConfig.xmlä¸­é…ç½®çš„*mapper.xmlçš„å…¨è·¯å¾„æ¥è§£æ*mapper.xmlå¹¶å°è£…åˆ°MappedStatementé…ç½®ç±»
           *        å†å°†MappedStatementèµ‹å€¼ç»™Configurationçš„mappedStatementMapå±æ€§
           */
  
  
          //è¿”å›æ ¸å¿ƒé…ç½®ç±»
          return configuration;
      }
  }
  ```

* **ç¬¬ä¸‰æ­¥ï¼šåˆ›å»ºXMLMapperBuilderç±»ï¼Œæ¥è§£æmapper.xml**

  åœ¨``com.eayon.config``ä¸‹åˆ›å»º``XMLMapperBuilder``å¹¶æä¾›``parse()``æ–¹æ³•

  è¯¥æ–¹æ³•ä½¿ç”¨``dom4j``å°†``mapper.xml``å­—èŠ‚æµè¿›è¡Œè§£æå¹¶å°è£…åˆ°``MappedStatement``é…ç½®å®ä½“ï¼Œå¹¶å°†è¯¥å®ä½“èµ‹å€¼ç»™``Configuration``ä¸­çš„å±æ€§ã€‚

  ```java
  package com.eayon.config;
  
  import com.eayon.pojo.Configuration;
  import com.eayon.pojo.MappedStatement;
  import org.dom4j.Document;
  import org.dom4j.DocumentException;
  import org.dom4j.Element;
  import org.dom4j.io.SAXReader;
  
  import java.io.InputStream;
  import java.util.List;
  import java.util.Map;
  
  /**
   * ä½¿ç”¨dom4jè§£æmapper.xml
   */
  public class XMLMapperBuilder {
  
      //å£°æ˜æ ¸å¿ƒé…ç½®ç±»æˆå‘˜å˜é‡
      private Configuration configuration;
  
      //åœ¨ä½¿ç”¨æœ‰å‚æ„é€ newçš„æ—¶å€™ä¼šå°†ä¼ é€’çš„configurationè¿›è¡Œèµ‹å€¼
      public XMLMapperBuilder(Configuration configuration) {
          this.configuration = configuration;
      }
  
      /**
       * è¯¥æ–¹æ³•ä½¿ç”¨dom4jå°†mapper.xmlå­—èŠ‚æµè¿›è¡Œè§£æå¹¶å°è£…åˆ°MappedStatementé…ç½®å®ä½“ï¼Œå¹¶å°†è¯¥å®ä½“èµ‹å€¼ç»™Configurationä¸­çš„å±æ€§ã€‚
       *
       * @param is *mapper.xmlçš„å­—èŠ‚æµ
       */
      public void parse(InputStream is) throws DocumentException {
          //é€šè¿‡dom4jè¯»å–mapper.xmlå­—èŠ‚æµç”ŸæˆDom
          Document document = new SAXReader().read(is);
          //æ‹¿åˆ°æ ¹å…ƒç´ ï¼Œä¹Ÿå°±æ˜¯mapper.xmlæ–‡ä»¶ä¸­çš„mapperæ ‡ç­¾
          Element mapperElement = document.getRootElement();
          //æŸ¥æ‰¾æ ¹å…ƒç´ ä¸‹æ‰€æœ‰çš„selectæ ‡ç­¾å…ƒç´ 
          List<Element> selectElements = mapperElement.selectNodes("//select");
  
          //è·å–æ¯ä¸ªselectæ“ä½œçš„SQLé…ç½®
          for (Element selectElement : selectElements) {
              String id = selectElement.attributeValue("id");
              String resultType = selectElement.attributeValue("resultType");
              String paramterType = selectElement.attributeValue("paramterType");
              String sql = selectElement.getTextTrim();//sqlè¯­å¥
              //å°è£…åˆ°MappedStatement
              MappedStatement mappedStatement = new MappedStatement();
              mappedStatement.setId(id);
              mappedStatement.setResultType(resultType);
              mappedStatement.setParamterType(paramterType);
              mappedStatement.setSql(sql);
              //å°†æ¯ä¸ªMappedStatementå­˜å‚¨åˆ°Configurationçš„MappedStatementMapå±æ€§ä¸­
              Map<String, MappedStatement> mappedStatementMap = configuration.getMappedStatementMap();
              //æ„å»ºmappedStatementMapçš„key ï¼šstatementIdï¼ˆnamespace.idï¼‰ï¼Œé€šè¿‡statementIdå¯ä»¥å®šä½åˆ°æ¯ä¸€æ¡SQL
              String namespace = mapperElement.attributeValue("namespace");
              String statementId = namespace + "." + id;
              mappedStatementMap.put(statementId, mappedStatement);
          }
  
      }
  }
  ```

* **ç¬¬å››æ­¥ï¼šå®Œå–„XMLConfigBuilderç±»ä¸­parseConfig()æ–¹æ³•çš„ç¬¬äºŒæ­¥**

  ```java
  package com.eayon.config;
  
  import com.eayon.io.Resources;
  import com.eayon.pojo.Configuration;
  import com.mchange.v2.c3p0.ComboPooledDataSource;
  import org.dom4j.Document;
  import org.dom4j.DocumentException;
  import org.dom4j.Element;
  import org.dom4j.io.SAXReader;
  
  import java.beans.PropertyVetoException;
  import java.io.InputStream;
  import java.util.List;
  import java.util.Properties;
  
  /**
   * ä½¿ç”¨dom4jè§£æsqlMapConfig.xmlçš„å­—èŠ‚æµå°è£…åˆ°Configurationæ ¸å¿ƒé…ç½®ç±»
   */
  public class XMLConfigBuilder {
  
      //å£°æ˜æ ¸å¿ƒé…ç½®ç±»æˆå‘˜å˜é‡
      private Configuration configuration;
  
      //åœ¨new XMLConfigBuilderçš„æ—¶å€™å°±ä¼šé€šè¿‡æ— å‚æ„é€ ç»™æˆå‘˜å˜é‡configurationè¿›è¡Œèµ‹å€¼
      public XMLConfigBuilder() {
          this.configuration = new Configuration();
      }
  
      /**
       * è¯¥æ–¹æ³•ä½¿ç”¨dom4jå°†sqlMapConfig.xmlåœ¨å†…å­˜ä¸­çš„å­—èŠ‚æµå°è£…åˆ°Configurationæ ¸å¿ƒé…ç½®ç±»å¹¶è¿”å›ã€‚
       *
       * @param is æ ¸å¿ƒé…ç½®æ–‡ä»¶qlMapConfig.xmlçš„å­—èŠ‚æµ
       * @return
       */
      public Configuration parseConfig(InputStream is) throws DocumentException, PropertyVetoException {
  
          /**
           * ç¬¬ä¸€æ­¥ï¼šé€šè¿‡dom4jè§£ææ ¸å¿ƒé…ç½®æ–‡ä»¶å°è£…åˆ°Configurationé…ç½®ç±»
           */
          //é€šè¿‡dom4jè¯»å–æ ¸å¿ƒé…ç½®æ–‡ä»¶å­—èŠ‚æµç”ŸæˆDom
          Document document = new SAXReader().read(is);
          //æ‹¿åˆ°æ ¹å…ƒç´ ï¼Œä¹Ÿå°±æ˜¯sqlMapConfig.xmlæ–‡ä»¶ä¸­çš„configurationæ ‡ç­¾
          Element configElement = document.getRootElement();
          //æŸ¥æ‰¾æ ¹å…ƒç´ ä¸‹æ‰€æœ‰çš„propertyæ ‡ç­¾å…ƒç´ 
          List<Element> propertyElements = configElement.selectNodes("//property");
          //é€šè¿‡Propertieså­˜å‚¨æ•°æ®æºä¿¡æ¯nameä»¥åŠvalueå€¼
          Properties dataSources = new Properties();
          //è·å–æ¯ä¸€ä¸ªpropertyå…ƒç´ çš„nameä»¥åŠvalueå€¼
          for (Element propertyElement : propertyElements) {
              String name = propertyElement.attributeValue("name");
              String value = propertyElement.attributeValue("value");
              //å°†nameã€valueå¯¹åº”çš„å­˜å…¥Properties
              dataSources.setProperty(name,value);
          }
  
          //åˆ›å»ºæ•°æ®åº“è¿æ¥æ± 
          ComboPooledDataSource comboPooledDataSource = new ComboPooledDataSource();
          //è®¾ç½®æ•°æ®æºä¿¡æ¯
          comboPooledDataSource.setDriverClass(dataSources.getProperty("driverClass"));
          comboPooledDataSource.setJdbcUrl(dataSources.getProperty("jdbcUrl"));
          comboPooledDataSource.setUser(dataSources.getProperty("username"));
          comboPooledDataSource.setPassword(dataSources.getProperty("password"));
  
          //å°†æ•°æ®æºå°è£…åˆ°Configurationå¯¹è±¡
          configuration.setDataSource(comboPooledDataSource);
  
          /**
           * ç¬¬äºŒæ­¥ï¼šé€šè¿‡sqlMapConfig.xmlä¸­é…ç½®çš„*mapper.xmlçš„å…¨è·¯å¾„æ¥è§£æ*mapper.xmlå¹¶å°è£…åˆ°MappedStatementé…ç½®ç±»
           *        å†å°†MappedStatementèµ‹å€¼ç»™Configurationçš„mappedStatementMapå±æ€§
           */
          //mapper.xmlè§£æï¼šæ‹¿åˆ°mapper.xmlè·¯å¾„ã€é€šè¿‡dom4jè§£æ
          List<Element> mapperElements = configElement.selectNodes("//mapper");
          //sqlMapConfig.xmlä¸­å¯èƒ½ä¼šé…ç½®å¤šä¸ª*mapper.xmlçš„åœ°å€ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ä¼šè·å–åˆ°å¤šä¸ªåœ°å€
          for (Element mapperElement : mapperElements) {
              String mapperPath = mapperElement.attributeValue("resource");
              //è·å–*mapper.xmlçš„å­—èŠ‚è¾“å…¥æµ
              InputStream mapperStream = Resources.getResourceAsStream(mapperPath);
              XMLMapperBuilder xmlMapperBuilder = new XMLMapperBuilder(configuration);
              xmlMapperBuilder.parse(mapperStream);
          }
  
          //è¿”å›æ ¸å¿ƒé…ç½®ç±»
          return configuration;
      }
  }
  ```

* **ç¬¬äº”æ­¥ï¼šå®Œå–„SqlSessionFactoryBuildç±»ä¸­çš„buildæ–¹æ³•ä¸­çš„ç¬¬ä¸€æ­¥**

  ```java
  package com.eayon.sqlSession;
  
  
  import com.eayon.config.XMLConfigBuilder;
  import com.eayon.pojo.Configuration;
  import org.dom4j.DocumentException;
  
  import java.beans.PropertyVetoException;
  import java.io.InputStream;
  
  /**
   * æ„å»ºè€…ç±»ï¼šç”¨äºåˆ›å»ºSqlSessionFactory
   */
  public class SqlSessionFactoryBuilder {
  
      public SqlsessionFactory build(InputStream is) throws PropertyVetoException, DocumentException {
          //ç¬¬ä¸€ï¼šä½¿ç”¨dom4jè§£æé…ç½®æ–‡ä»¶ï¼Œå°†è§£æå‡ºæ¥çš„å†…å®¹å°è£…åˆ°Configurationä¸­
          XMLConfigBuilder xmlConfigBuilder = new XMLConfigBuilder();
          Configuration configuration = xmlConfigBuilder.parseConfig(is);
  
          //ç¬¬äºŒï¼šåˆ›å»ºSqlsessionFactoryå·¥å‚
  
          return null;
      }
  }
  ```

  è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å·²ç»æŠŠ``sqlMapConfig.xml``ä»¥åŠ``*mapper.xml``é…ç½®æ–‡ä»¶å…¨éƒ¨è§£æåˆ°äº†``Configuration``æ ¸å¿ƒé…ç½®ç±»ä¸­ï¼Œ

  æ¥ä¸‹æ¥è¿›å…¥ä¸‹ä¸€æ­¥ï¼šåˆ›å»º``SqlSessionFactory``æ¥å£åŠå®ç°ç±»``DefaultSqlSessionFactory``



### 3.4 åˆ›å»ºSqlSessionFactoryæ¥å£åŠå®ç°ç±»DefaultSqlSessionFactory

**è‡ªå®šä¹‰æŒä¹…å±‚æ¡†æ¶ç«¯**

> æˆ‘ä»¬å…ˆæƒ³æƒ³``DefaultSqlSessionFactory``æ˜¯ä¸€ä¸ª``Session``å·¥å‚ï¼Œé€šè¿‡``Session``å°è£…çš„æŒä¹…åŒ–æ–¹æ³•å»æ“ä½œæ•°æ®åº“ï¼Œé‚£ä¹ˆç”±æ­¤æ¥çœ‹æˆ‘ä»¬å…ˆåˆ›å»º``SqlSession``æ¯”è¾ƒå¥½ï¼Œç„¶ååœ¨åˆ›å»º``DefaultSqlSessionFactory``

* **ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºSqlSessionæ¥å£**

  åœ¨``com.eayon.sqlSession``ä¸‹åˆ›å»º``SqlSession``æ¥å£ï¼ˆæš‚ä¸ç¼–å†™å…·ä½“å†…å®¹ï¼‰

  ```java
  package com.eayon.sqlSession;
  
  /**
   * SqlSession
   */
  public interface SqlSession {
      
  }
  ```

* **ç¬¬äºŒæ­¥ï¼šåˆ›å»ºå®ç°ç±»DefaultSqlSession**

  åœ¨``com.eayon.sqlSession``ä¸‹åˆ›å»º``SqlSession``æ¥å£ï¼ˆæš‚ä¸ç¼–å†™å…·ä½“å†…å®¹ï¼‰

  ```java
  package com.eayon.sqlSession;
  
  import com.eayon.pojo.Configuration;
  
  /**
   * SqlSessionå®ç°ç±»
   */
  public class DefaultSqlSession implements SqlSession {
      //å£°æ˜æ ¸å¿ƒé…ç½®ç±»æˆå‘˜å˜é‡
      private Configuration configuration;
  
      //åœ¨ä½¿ç”¨æœ‰å‚æ„é€ newçš„æ—¶å€™ä¼šå°†ä¼ é€’çš„configurationè¿›è¡Œèµ‹å€¼
      public DefaultSqlSession(Configuration configuration) {
          this.configuration = configuration;
      }
      
      //æš‚ä¸ç¼–å†™å…¶ä»–å…·ä½“å†…å®¹
  
  }
  ```

* **ç¬¬ä¸‰æ­¥ï¼šåˆ›å»ºSqlSessionFactoryæ¥å£**

  åœ¨``com.eayon.sqlSession``ä¸‹åˆ›å»º``SqlSessionFactory``æ¥å£ï¼Œæä¾›``openSession()``æ–¹æ³•ç”¨äºç”Ÿäº§``session``

  ```java
  package com.eayon.sqlSession;
  
  /**
   * SqlsessionFactoryå·¥å‚
   */
  public interface SqlsessionFactory {
  
      //ç”Ÿäº§session
      public SqlSession openSession();
  }
  ```

* **ç¬¬å››æ­¥ï¼šåˆ›å»ºDefaultSqlSessionFactoryå®ç°ç±»**

  åœ¨``com.eayon.sqlSession``ä¸‹åˆ›å»º``DefaultSqlSessionFactory``å®ç°ç±»ï¼Œå®ç°``openSession()``æ–¹æ³•ç”¨äºç”Ÿäº§``session``

  ```java
  package com.eayon.sqlSession;
  
  import com.eayon.pojo.Configuration;
  
  /**
   * SqlSessionFactoryå·¥å‚
   */
  public class DefaultSqlSessionFactory implements SqlessionFactory {
  
      //å£°æ˜æ ¸å¿ƒé…ç½®ç±»æˆå‘˜å˜é‡
      private Configuration configuration;
  
      //åœ¨ä½¿ç”¨æœ‰å‚æ„é€ newçš„æ—¶å€™ä¼šå°†ä¼ é€’çš„configurationè¿›è¡Œèµ‹å€¼
      public DefaultSqlSessionFactory(Configuration configuration) {
          this.configuration = configuration;
      }
  
  
      /**
       * ç”Ÿäº§SqlSession
       * @return
       */
      @Override
      public SqlSession openSession() {
          return new DefaultSqlSession(configuration);
      }
  }
  ```

* **ç¬¬äº”æ­¥ï¼šå®Œå–„SqlSessionFactoryBuilderä¸­çš„ç¬¬äºŒæ­¥**

  ```java
  package com.eayon.sqlSession;
  
  
  import com.eayon.config.XMLConfigBuilder;
  import com.eayon.pojo.Configuration;
  import org.dom4j.DocumentException;
  
  import java.beans.PropertyVetoException;
  import java.io.InputStream;
  
  /**
   * æ„å»ºè€…ç±»ï¼šç”¨äºåˆ›å»ºSqlSessionFactory
   */
  public class SqlSessionFactoryBuilder {
  
      public SqlsessionFactory build(InputStream is) throws PropertyVetoException, DocumentException {
          //ç¬¬ä¸€ï¼šä½¿ç”¨dom4jè§£æé…ç½®æ–‡ä»¶ï¼Œå°†è§£æå‡ºæ¥çš„å†…å®¹å°è£…åˆ°Configurationä¸­
          XMLConfigBuilder xmlConfigBuilder = new XMLConfigBuilder();
          Configuration configuration = xmlConfigBuilder.parseConfig(is);
  
          //ç¬¬äºŒï¼šåˆ›å»ºSqlsessionFactoryå·¥å‚
          DefaultSqlSessionFactory sqlSessionFactory = new DefaultSqlSessionFactory(configuration);
          return sqlSessionFactory;
      }
  }
  ```



### 3.5 åˆ›å»ºExecutoræ¥å£åŠå®ç°ç±»SimpleExecutor

> é€šè¿‡ä¸Šé¢çš„æ­¥éª¤æˆ‘ä»¬ä»¥åŠå¯ä»¥é€šè¿‡``SqlSessionFactory.build()``æ–¹æ³•åˆ›å»º``sqlSessionFactory``å·¥å‚ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡``sqlSessionFactory.openSession()``æ–¹æ³•ç”Ÿäº§``session``ï¼Œç„¶ååœ¨``session``ä¸­å°è£…CRUDæ–¹æ³•å¯¹æ•°æ®åº“è¿›è¡ŒæŒä¹…åŒ–æ“ä½œã€‚æˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨``session``çš„CRUDæ–¹æ³•ä¸­å†™jdbcä»£ç ï¼Œä½†æ˜¯æˆ‘ä»¬æœ€å¥½å†å°è£…ä¸€å±‚ã€‚åˆ›å»º``Executor``æ¥å£åŠå®ç°ç±»``SimpleExcutor``ï¼Œåœ¨``SimpleExcutor``å†™jdbcä»£ç ï¼Œé‚£ä¹ˆ``session``ä¸­çš„CRUDæ–¹æ³•é€šè¿‡è°ƒç”¨``SimpleExcutor``ä¸­çš„jdbcä»£ç å®ç°å¯¹æ•°æ®åº“çš„æ“ä½œã€‚

**è‡ªå®šä¹‰æŒä¹…å±‚æ¡†æ¶ç«¯**

* **ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºExecutoræ¥å£**

  åœ¨``com.eayon.sqlSession``ä¸‹åˆ›å»º``Executor``æ¥å£å¹¶å®šä¹‰ä¸€ä¸ª``query``æ–¹æ³•

  ```java
  package com.eayon.sqlSession;
  
  import com.eayon.pojo.Configuration;
  import com.eayon.pojo.MappedStatement;
  
  import java.util.List;
  
  /**
   * å°è£…CRUDæ–¹æ³•ï¼Œå…¶å®å°±æ˜¯å¯¹jdbcä»£ç çš„è¿›ä¸€æ­¥å°è£…
   */
  public interface Executor {
  
      /**
       * æŸ¥è¯¢
       * @param configuration æ ¸å¿ƒé…ç½®ç±»
       * @param mappedStatement SQLé…ç½®ä¿¡æ¯
       * @param params å¯å˜å‚æ•°
       * @param <E>
       * @return
       */
      public <E> List<E> query(Configuration configuration, MappedStatement mappedStatement, Object... params);
  }
  ```

* **ç¬¬äºŒæ­¥ï¼šæ·»åŠ æ ‡è®°å¤„ç†å·¥å…·ç±»**

  åœ¨``com.eayon.util``ä¸‹æ·»åŠ ä¸‹é¢å››ä¸ªå·¥å…·ç±»ï¼Œéƒ½æ˜¯æˆ‘ä»Mybatiså¤åˆ¶è¿‡æ¥çš„ã€‚ä¸»è¦ç”¨äºå¯¹å®¢æˆ·ç«¯è‡ªå®šä¹‰SQLä¸­çš„#{}ç¬¦å·è¿›è¡Œè§£æç­‰å¤„ç†ï¼Œè§£æä¸ºjdbcå¯è¯†åˆ«çš„æ ¼å¼ã€‚**å¯ä»¥æš‚æ—¶ä¸ç”¨å…³å¿ƒè¿™äº›æ˜¯å¹²ä»€ä¹ˆçš„**ã€‚å¦‚æœæ„Ÿè§‰æ¯”è¾ƒä¹±ï¼Œå¯ä»¥ä¸‹è½½ä»£ç ç›´æ¥å¤åˆ¶ï¼š[é“¾æ¥](https://github.com/EayonLee/JavaGod/tree/main/1é˜¶æ®µï¼šå¼€æºæ¡†æ¶æºç å‰–æ/01æ¨¡å—ï¼šè‡ªå®šä¹‰æŒä¹…å±‚æ¡†æ¶è®¾è®¡åŠMyBatisæºç åˆ†æ/01.è‡ªå®šä¹‰æŒä¹…å±‚æ¡†æ¶/01.è¯¾ç¨‹èµ„æ–™)

  **GenericTokenParser**

  ```java
  /**
   *    Copyright 2009-2017 the original author or authors.
   *
   *    Licensed under the Apache License, Version 2.0 (the "License");
   *    you may not use this file except in compliance with the License.
   *    You may obtain a copy of the License at
   *
   *       http://www.apache.org/licenses/LICENSE-2.0
   *
   *    Unless required by applicable law or agreed to in writing, software
   *    distributed under the License is distributed on an "AS IS" BASIS,
   *    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   *    See the License for the specific language governing permissions and
   *    limitations under the License.
   */
  package com.eayon.util;
  
  /**
   * @author Clinton Begin
   */
  public class GenericTokenParser {
  
    private final String openToken; //å¼€å§‹æ ‡è®°
    private final String closeToken; //ç»“æŸæ ‡è®°
    private final TokenHandler handler; //æ ‡è®°å¤„ç†å™¨
  
    public GenericTokenParser(String openToken, String closeToken, TokenHandler handler) {
      this.openToken = openToken;
      this.closeToken = closeToken;
      this.handler = handler;
    }
  
    /**
     * è§£æ${}å’Œ#{}
     * @param text
     * @return
     * è¯¥æ–¹æ³•ä¸»è¦å®ç°äº†é…ç½®æ–‡ä»¶ã€è„šæœ¬ç­‰ç‰‡æ®µä¸­å ä½ç¬¦çš„è§£æã€å¤„ç†å·¥ä½œï¼Œå¹¶è¿”å›æœ€ç»ˆéœ€è¦çš„æ•°æ®ã€‚
     * å…¶ä¸­ï¼Œè§£æå·¥ä½œç”±è¯¥æ–¹æ³•å®Œæˆï¼Œå¤„ç†å·¥ä½œæ˜¯ç”±å¤„ç†å™¨handlerçš„handleToken()æ–¹æ³•æ¥å®ç°
     */
    public String parse(String text) {
      // éªŒè¯å‚æ•°é—®é¢˜ï¼Œå¦‚æœæ˜¯nullï¼Œå°±è¿”å›ç©ºå­—ç¬¦ä¸²ã€‚
      if (text == null || text.isEmpty()) {
        return "";
      }
  
      // ä¸‹é¢ç»§ç»­éªŒè¯æ˜¯å¦åŒ…å«å¼€å§‹æ ‡ç­¾ï¼Œå¦‚æœä¸åŒ…å«ï¼Œé»˜è®¤ä¸æ˜¯å ä½ç¬¦ï¼Œç›´æ¥åŸæ ·è¿”å›å³å¯ï¼Œå¦åˆ™ç»§ç»­æ‰§è¡Œã€‚
      int start = text.indexOf(openToken, 0);
      if (start == -1) {
        return text;
      }
  
     // æŠŠtextè½¬æˆå­—ç¬¦æ•°ç»„srcï¼Œå¹¶ä¸”å®šä¹‰é»˜è®¤åç§»é‡offset=0ã€å­˜å‚¨æœ€ç»ˆéœ€è¦è¿”å›å­—ç¬¦ä¸²çš„å˜é‡builderï¼Œ
      // textå˜é‡ä¸­å ä½ç¬¦å¯¹åº”çš„å˜é‡åexpressionã€‚åˆ¤æ–­startæ˜¯å¦å¤§äº-1(å³textä¸­æ˜¯å¦å­˜åœ¨openToken)ï¼Œå¦‚æœå­˜åœ¨å°±æ‰§è¡Œä¸‹é¢ä»£ç 
      char[] src = text.toCharArray();
      int offset = 0;
      final StringBuilder builder = new StringBuilder();
      StringBuilder expression = null;
      while (start > -1) {
       // åˆ¤æ–­å¦‚æœå¼€å§‹æ ‡è®°å‰å¦‚æœæœ‰è½¬ä¹‰å­—ç¬¦ï¼Œå°±ä¸ä½œä¸ºopenTokenè¿›è¡Œå¤„ç†ï¼Œå¦åˆ™ç»§ç»­å¤„ç†
        if (start > 0 && src[start - 1] == '\\') {
          builder.append(src, offset, start - offset - 1).append(openToken);
          offset = start + openToken.length();
        } else {
          //é‡ç½®expressionå˜é‡ï¼Œé¿å…ç©ºæŒ‡é’ˆæˆ–è€…è€æ•°æ®å¹²æ‰°ã€‚
          if (expression == null) {
            expression = new StringBuilder();
          } else {
            expression.setLength(0);
          }
          builder.append(src, offset, start - offset);
          offset = start + openToken.length();
          int end = text.indexOf(closeToken, offset);
          while (end > -1) {////å­˜åœ¨ç»“æŸæ ‡è®°æ—¶
            if (end > offset && src[end - 1] == '\\') {//å¦‚æœç»“æŸæ ‡è®°å‰é¢æœ‰è½¬ä¹‰å­—ç¬¦æ—¶
              // this close token is escaped. remove the backslash and continue.
              expression.append(src, offset, end - offset - 1).append(closeToken);
              offset = end + closeToken.length();
              end = text.indexOf(closeToken, offset);
            } else {//ä¸å­˜åœ¨è½¬ä¹‰å­—ç¬¦ï¼Œå³éœ€è¦ä½œä¸ºå‚æ•°è¿›è¡Œå¤„ç†
              expression.append(src, offset, end - offset);
              offset = end + closeToken.length();
              break;
            }
          }
          if (end == -1) {
            // close token was not found.
            builder.append(src, start, src.length - start);
            offset = src.length;
          } else {
            //é¦–å…ˆæ ¹æ®å‚æ•°çš„keyï¼ˆå³expressionï¼‰è¿›è¡Œå‚æ•°å¤„ç†ï¼Œè¿”å›?ä½œä¸ºå ä½ç¬¦
            builder.append(handler.handleToken(expression.toString()));
            offset = end + closeToken.length();
          }
        }
        start = text.indexOf(openToken, offset);
      }
      if (offset < src.length) {
        builder.append(src, offset, src.length - offset);
      }
      return builder.toString();
    }
  }
  ```

  **ParameterMapping**

  ```java
  package com.eayon.util;
  
  public class ParameterMapping {
  
      private String content;
  
      public ParameterMapping(String content) {
          this.content = content;
      }
  
      public String getContent() {
          return content;
      }
  
      public void setContent(String content) {
          this.content = content;
      }
  }
  ```

  **ParameterMappingTokenHandler**

  ```java
  package com.eayon.util;
  
  import java.util.ArrayList;
  import java.util.List;
  
  
  public class ParameterMappingTokenHandler implements TokenHandler {
     private List<ParameterMapping> parameterMappings = new ArrayList<ParameterMapping>();
  
     // contextæ˜¯å‚æ•°åç§° #{id} #{username}
  
     @Override
     public String handleToken(String content) {
        parameterMappings.add(buildParameterMapping(content));
        return "?";
     }
  
     private ParameterMapping buildParameterMapping(String content) {
        ParameterMapping parameterMapping = new ParameterMapping(content);
        return parameterMapping;
     }
  
     public List<ParameterMapping> getParameterMappings() {
        return parameterMappings;
     }
  
     public void setParameterMappings(List<ParameterMapping> parameterMappings) {
        this.parameterMappings = parameterMappings;
     }
  
  }
  ```

  **TokenHandler**

  ```java
  /**
   *    Copyright 2009-2015 the original author or authors.
   *
   *    Licensed under the Apache License, Version 2.0 (the "License");
   *    you may not use this file except in compliance with the License.
   *    You may obtain a copy of the License at
   *
   *       http://www.apache.org/licenses/LICENSE-2.0
   *
   *    Unless required by applicable law or agreed to in writing, software
   *    distributed under the License is distributed on an "AS IS" BASIS,
   *    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   *    See the License for the specific language governing permissions and
   *    limitations under the License.
   */
  package com.eayon.util;
  
  /**
   * @author Clinton Begin
   */
  public interface TokenHandler {
    String handleToken(String content);
  }
  ```

* **ç¬¬ä¸‰æ­¥ï¼šåˆ›å»ºBoundSqlç±»**

  åœ¨``com.eayon.config``ä¸‹åˆ›å»º``BoundSql``ï¼Œè¯¥ç±»ä¸»è¦ç”¨äºå°è£…å­˜å‚¨é€šè¿‡ä¸Šé¢å·¥å…·ç±»è§£æåçš„SQLè¯­å¥ã€‚**å¯ä»¥æš‚æ—¶ä¸ç”¨å…³å¿ƒè¿™äº›æ˜¯å¹²ä»€ä¹ˆçš„**

  ```java
  package com.eayon.config;
  
  import com.eayon.util.ParameterMapping;
  
  import java.util.ArrayList;
  import java.util.List;
  
  /**
   * è½¬æ¢å¹¶èµ‹å€¼åçš„SQLè¯­å¥
   */
  public class BoundSql {
  
      private String sql;//è§£æåçš„sql
      private List<ParameterMapping> parameterMappingList = new ArrayList<>();//#{}é‡Œé¢è§£æå‡ºæ¥çš„å‚æ•°åç§°
  
      public BoundSql(String sql, List<ParameterMapping> parameterMappingList) {
          this.sql = sql;
          this.parameterMappingList = parameterMappingList;
      }
  
      public String getSql() {
          return sql;
      }
  
      public void setSql(String sql) {
          this.sql = sql;
      }
  
      public List<ParameterMapping> getParameterMappingList() {
          return parameterMappingList;
      }
  
      public void setParameterMappingList(List<ParameterMapping> parameterMappingList) {
          this.parameterMappingList = parameterMappingList;
      }
  }
  ```

* **ç¬¬å››æ­¥ï¼šåˆ›å»ºå®ç°ç±»SimpleExecutorå¹¶å®šä¹‰queryæ–¹æ³•**

  åœ¨``com.eayon.sqlSession``ä¸‹åˆ›å»º``SimpleExecutor``å®ç°ç±»å¹¶å®ç°``query``æ–¹æ³•

  ```java
  package com.eayon.sqlSession;
  
  import com.eayon.config.BoundSql;
  import com.eayon.pojo.Configuration;
  import com.eayon.pojo.MappedStatement;
  import com.eayon.util.GenericTokenParser;
  import com.eayon.util.ParameterMapping;
  import com.eayon.util.ParameterMappingTokenHandler;
  
  import java.beans.PropertyDescriptor;
  import java.lang.reflect.Field;
  import java.lang.reflect.Method;
  import java.sql.*;
  import java.util.ArrayList;
  import java.util.List;
  
  /**
   * å°è£…CRUDæ–¹æ³•ï¼Œå…¶å®å°±æ˜¯å¯¹jdbcä»£ç çš„è¿›ä¸€æ­¥å°è£…
   */
  public class SimpleExecutor implements Executor {
  
      /**
       * æŸ¥è¯¢
       *
       * @param configuration   æ ¸å¿ƒé…ç½®ç±»
       * @param mappedStatement SQLé…ç½®ä¿¡æ¯
       * @param params          å¯å˜å‚æ•°
       * @param <E>
       * @return
       */
      @Override
      public <E> List<E> query(Configuration configuration, MappedStatement mappedStatement, Object... params) throws Exception {
          // 1. æ³¨å†Œé©±åŠ¨ï¼Œè·å–è¿æ¥
          Connection connection = configuration.getDataSource().getConnection();
  
          //2.è·å–æœ¬æ¬¡æ“ä½œçš„sqlè¯­å¥
          String sql = mappedStatement.getSql();
          //æ¯”å¦‚è·å–åˆ°çš„SQLæ ¼å¼ï¼šselect * from user where id = #{id} and username = #{username} jdbcæ— æ³•è¯†åˆ«ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è½¬æ¢
          //æ¯”å¦‚è½¬ä¸ºselect * from user where id = ? and username = ? è¿™æ ·çš„æ ¼å¼ï¼Œå¹¶ä¸”è¿˜éœ€è¦å¯¹#{}é‡Œé¢çš„å€¼è¿›è¡Œè§£æå­˜å‚¨
          //è½¬æ¢SQL
          BoundSql boundSql = getBoundSql(sql);
  
          // 3.è·å–é¢„å¤„ç†å¯¹è±¡ï¼špreparedStatement
          PreparedStatement preparedStatement = connection.prepareStatement(boundSql.getSql());
  
          //4.è®¾ç½®å‚æ•°
          //è·å–æŸ¥è¯¢å‚æ•°ç±»å‹çš„å…¨è·¯å¾„  å¦‚ï¼šcom.eayon.pojo.User
          String paramterType = mappedStatement.getParamterType();
          //è·å–åˆ°æŸ¥è¯¢å‚æ•°ç±»å‹çš„Classå­—èŠ‚ç å¯¹è±¡   å¦‚ï¼šclass com.eayon.pojo.User
          Class<?> paramtertypeClass = getClassType(paramterType);
  
          //è·å–åŸå§‹SQLä¸­#{}é‡Œé¢è®¾ç½®çš„å‚æ•°åç§°é›†åˆ  å¦‚ï¼šidï¼Œusername
          List<ParameterMapping> parameterMappingList = boundSql.getParameterMappingList();
          //éå†å‚æ•°åç§°é›†åˆï¼Œ
          for (int i = 0; i < parameterMappingList.size(); i++) {
              //å¾ªç¯å–å‡ºåŸå§‹SQLä¸­#{}é‡Œé¢è®¾ç½®çš„å‚æ•°åç§°
              ParameterMapping parameterMapping = parameterMappingList.get(i);
              String content = parameterMapping.getContent();
  
              //ä½¿ç”¨åå°„ï¼Œæ ¹æ®å‚æ•°åè·å–å®ä½“å¯¹è±¡çš„å±æ€§å€¼ï¼Œ å†æ ¹æ®ä¼ é€’çš„å‚æ•°è¿›è¡Œèµ‹å€¼
              //é€šè¿‡Classè·å–åˆ°æŸä¸€ä¸ªå±æ€§å¯¹è±¡
              Field declaredField = paramtertypeClass.getDeclaredField(content);
              //æš´åŠ›è®¿é—®
              declaredField.setAccessible(true);
              //è·å–è¯¥å±æ€§å¯¹è±¡çš„å€¼
              Object o = declaredField.get(params[0]);
              //è®¾ç½®å‚æ•°
              preparedStatement.setObject(i+1,o);
          }
  
          // 5. æ‰§è¡Œsql
          ResultSet resultSet = preparedStatement.executeQuery();
  
          //è·å–è¿”å›ç»“æœçš„å®ä½“å…¨è·¯å¾„
          String resultType = mappedStatement.getResultType();
          //è·å–è¿”å›ç»“æœå®ä½“å…¨è·¯å¾„çš„Classï¼Œä¸»è¦ç”¨äºåå°„å°è£…ç»“æœé›†æ—¶ä½¿ç”¨
          Class<?> resultTypeClass = getClassType(resultType);
  
          //è¿”å›ç»“æœé›†
          ArrayList<Object> objects = new ArrayList<>();
  
          // 6. å°è£…è¿”å›ç»“æœé›†
          while (resultSet.next()){
              //è·å–è¿”å›ç»“æœå®ä½“å¯¹è±¡
              Object o =resultTypeClass.newInstance();
              //metaData.getColumnCount()  æŸ¥è¯¢ç»“æœé›†ä¸­çš„æ€»åˆ—æ•°  å¾ªç¯è·å–æ¯åˆ—æ•°æ®
              ResultSetMetaData metaData = resultSet.getMetaData();
              for (int i = 1; i <= metaData.getColumnCount(); i++) {
                  //è·å–æ•°æ®åº“ä¸­çš„å­—æ®µåç§°
                  String columnName = metaData.getColumnName(i);
                  //é€šè¿‡å­—æ®µåç§°å»æŸ¥è¯¢ç»“æœé›†ä¸­å–å‡ºå­—æ®µå€¼
                  Object value = resultSet.getObject(columnName);
                  //PropertyDescriptorï¼šå¯ä»¥é€šè¿‡æœ‰å‚æ„é€ è·å–è¯¥å­—æ®µåœ¨è¿”å›å€¼å®ä½“ä¸­çš„getã€setæ–¹æ³•
                  PropertyDescriptor propertyDescriptor = new PropertyDescriptor(columnName, resultTypeClass);
                  //ç„¶åæˆ‘ä»¬å°±å¯ä»¥è·å–åˆ°è¿™ä¸ªè¿”å›å€¼å®ä½“çš„setæ–¹æ³•
                  Method writeMethod = propertyDescriptor.getWriteMethod();
                  //æŠŠè¯¥å­—æ®µå€¼setåˆ°å®ä½“é‡Œé¢å³å¯
                  writeMethod.invoke(o,value);
              }
              //å°è£…åˆ°è¿”å›ç»“æœé›†
              objects.add(o);
          }
  
          //è¿”å›æŸ¥è¯¢ç»“æœ
          return (List<E>) objects;
      }
  
  
      /**
       * é€šè¿‡æŸ¥è¯¢å‚æ•°çš„å…¨è·¯å¾„è·å–åˆ°Class
       *
       * @param paramterType å‚æ•°çš„å…¨è·¯å¾„
       * @return
       * @throws ClassNotFoundException
       */
      private Class<?> getClassType(String paramterType) throws ClassNotFoundException {
          if (paramterType != null) {
              Class<?> aClass = Class.forName(paramterType);
              return aClass;
          }
          return null;
      }
  
      /**
       * å®Œæˆå¯¹SQLè¯­å¥çš„è§£æï¼š
       * 1ã€å°†#{}ä½¿ç”¨?è¿›è¡Œä»£æ›¿
       * 2ã€è§£æå‡º#{}é‡Œé¢çš„å€¼è¿›è¡Œå­˜å‚¨
       *
       * @param sql
       * @return
       */
      public BoundSql getBoundSql(String sql) {
          //æ ‡è®°å¤„ç†ç±»ï¼šé…ç½®æ ‡è®°è§£æå™¨æ¥å®Œæˆå¯¹å ä½ç¬¦çš„è§£æå¤„ç†å·¥ä½œ
          ParameterMappingTokenHandler parameterMappingTokenHandler = new ParameterMappingTokenHandler();
          GenericTokenParser genericTokenParser = new GenericTokenParser("#{", "}", parameterMappingTokenHandler);
          //è§£æå‡ºæ¥çš„sql
          String parseSql = genericTokenParser.parse(sql);
          //#{}é‡Œé¢è§£æå‡ºæ¥çš„å‚æ•°åç§°
          List<ParameterMapping> parameterMappings = parameterMappingTokenHandler.getParameterMappings();
  
          //è§£æå¹¶å°è£…å¥½çš„SQLè¿›è¡Œè¿”å›
          BoundSql boundSql = new BoundSql(parseSql, parameterMappings);
          return boundSql;
      }
  }
  ```



### 3.6 å®šä¹‰SqlSessionä¸­çš„CRUDæ–¹æ³•

> é€šè¿‡ä¸Šé¢çš„æ­¥éª¤æˆ‘ä»¬ä»¥åŠå¯ä»¥é€šè¿‡``SqlSessionFactory.build()``æ–¹æ³•åˆ›å»º``sqlSessionFactory``å·¥å‚ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡``sqlSessionFactory.openSession()``æ–¹æ³•ç”Ÿäº§``session``ï¼Œè€Œä¸”ä¹Ÿåœ¨``Executor``ä¸­å°è£…å¥½jdbcä»£ç ã€‚ä½†æ˜¯``session``ä¸­è¿˜æ²¡æœ‰å®šä¹‰è°ƒç”¨``Executor``çš„æ–¹æ³•ã€‚é‚£æˆ‘ä»¬å°±æ¥å®Œå–„SqlSession

**è‡ªå®šä¹‰æŒä¹…å±‚æ¡†æ¶ç«¯**

* **ç¬¬ä¸€æ­¥ï¼šå®Œå–„SqlSessionæ¥å£**

  ```java
  package com.eayon.sqlSession;
  
  import java.util.List;
  
  /**
   * SqlSession
   */
  public interface SqlSession {
  
      /**
       * æŸ¥è¯¢æ‰€æœ‰
       *
       * @param statementId statementIdï¼ˆnamespace.idï¼‰ï¼Œé€šè¿‡statementIdå¯ä»¥å®šä½åˆ°æ¯ä¸€æ¡SQL
       * @param params å¯å˜å‚æ•°
       * @param <E>
       * @return
       */
      public <E> List<E> selectList(String statementId, Object... params);
  
      /**
       * æ ¹æ®æ¡ä»¶æŸ¥è¯¢å•ä¸ª
       *
       * @param statementId statementIdï¼ˆnamespace.idï¼‰ï¼Œé€šè¿‡statementIdå¯ä»¥å®šä½åˆ°æ¯ä¸€æ¡SQL
       * @param params å¯å˜å‚æ•°
       * @return
       */
      public <T> T selectOne(String statementId, Object... params);
  }
  ```

* **ç¬¬äºŒæ­¥ï¼šå®Œå–„DefaultSqlSessionå®ç°ç±»**

  ```java
  package com.eayon.sqlSession;
  
  import com.eayon.pojo.Configuration;
  import com.eayon.pojo.MappedStatement;
  
  import java.util.List;
  import java.util.Map;
  
  /**
   * SqlSessionå®ç°ç±»
   */
  public class DefaultSqlSession implements SqlSession {
      //å£°æ˜æ ¸å¿ƒé…ç½®ç±»æˆå‘˜å˜é‡
      private Configuration configuration;
  
      //åœ¨ä½¿ç”¨æœ‰å‚æ„é€ newçš„æ—¶å€™ä¼šå°†ä¼ é€’çš„configurationè¿›è¡Œèµ‹å€¼
      public DefaultSqlSession(Configuration configuration) {
          this.configuration = configuration;
      }
  
      /**
       * æŸ¥è¯¢æ‰€æœ‰
       *
       * @param statementId statementIdï¼ˆnamespace.idï¼‰ï¼Œé€šè¿‡statementIdå¯ä»¥å®šä½åˆ°æ¯ä¸€æ¡SQL
       * @param params å¯å˜å‚æ•°
       * @param <E>
       * @return
       */
      @Override
      public <E> List<E> selectList(String statementId, Object... params) throws Exception {
          //åˆ›å»ºSimpleExecutor
          SimpleExecutor simpleExecutor = new SimpleExecutor();
          //é€šè¿‡æ ¸å¿ƒé…ç½®æ–‡ä»¶è·å–æ‰€æœ‰çš„MappedStatementé›†åˆ
          Map<String, MappedStatement> mappedStatementMap = configuration.getMappedStatementMap();
          //é€šè¿‡æœ¬æ¬¡æŸ¥è¯¢å‚æ•°ä¸­çš„statementIdï¼Œä»Mapé›†åˆä¸­æ‰¾å‡ºæœ¬æ¬¡æŸ¥è¯¢çš„SQLé…ç½®ï¼ˆSQLè¯­å¥ï¼Œè¿”å›å€¼ç±»å‹ï¼Œå‚æ•°ç±»å‹ç­‰ç­‰ï¼‰
          MappedStatement mappedStatement = mappedStatementMap.get(statementId);
          //è°ƒç”¨SimpleExecutorä¸­å¯¹jdbcå°è£…å¥½çš„queryæ–¹æ³•è¿›è¡ŒæŸ¥è¯¢
          List<E> list = simpleExecutor.query(configuration, mappedStatement, params);
          return list;
      }
  
      /**
       * æ ¹æ®æ¡ä»¶æŸ¥è¯¢å•ä¸ª
       *
       * @param statementId statementIdï¼ˆnamespace.idï¼‰ï¼Œé€šè¿‡statementIdå¯ä»¥å®šä½åˆ°æ¯ä¸€æ¡SQL
       * @param params å¯å˜å‚æ•°
       * @return
       */
      @Override
      public <T> T selectOne(String statementId, Object... params) throws Exception {
          List<Object> objects = selectList(statementId, params);
          if(objects.size() == 1){
              return (T) objects.get(0);
          }else {
              throw new RuntimeException("æŸ¥è¯¢ç»“æœä¸ºç©ºæˆ–è¿”å›ç»“æœè¿‡å¤š");
          }
      }
  }
  ```



### 3.7 å®¢æˆ·ç«¯æµ‹è¯•è¿è¡Œ

> åˆ«å¿˜äº†å°†è‡ªå®šä¹‰æ¡†æ¶é¡¹ç›®æ‰“åŒ…

**å®¢æˆ·ç«¯**

* **ç¬¬ä¸€æ­¥ï¼šæµ‹è¯•**

  ```java
  package com.eayon.test;
  
  
  import com.eayon.io.Resources;
  import com.eayon.pojo.User;
  import com.eayon.sqlSession.SqlSession;
  import com.eayon.sqlSession.SqlSessionFactoryBuilder;
  import com.eayon.sqlSession.SqlsessionFactory;
  import java.io.InputStream;
  import java.util.List;
  
  /**
   * æµ‹è¯•ç±»
   */
  public class MyTest {
  
      @Test
      public void test1() throws Exception {
          //è·å–æ ¸å¿ƒé…ç½®æ–‡ä»¶å­—èŠ‚æµ
          InputStream resourceAsStream = Resources.getResourceAsStream("sqlMapConfig.xml");
          //åˆ›å»ºsessionå·¥å‚
          SqlSessionFactoryBuilder sqlSessionFactoryBuilder = new SqlSessionFactoryBuilder();
          SqlsessionFactory sqlsessionFactory = sqlSessionFactoryBuilder.build(resourceAsStream);
          //é€šè¿‡sessionå·¥å‚åˆ›å»ºsession
          SqlSession sqlSession = sqlsessionFactory.openSession();
          //é€šè¿‡sessionæ“ä½œæ•°æ®åº“æŸ¥è¯¢
          User user = new User();
          user.setId(1);
          user.setUsername("å¼ ä¸‰");
          //å‚æ•°ä¸€ï¼šstatementId  (statementId.id)   å‚æ•°äºŒï¼šæŸ¥è¯¢å‚æ•°
          List<User> users = sqlSession.selectList("user.selectOne", user);
          for (User user1 : users) {
              System.out.println(user1);
          }
      }
  }
  ```

  è‡³æ­¤ç®€å•çš„è‡ªå®šä¹‰æŒä¹…å±‚æ¡†æ¶å°±å®Œæˆäº†ï¼Œä½†æ˜¯æˆ‘ä»¬å‘ç°åœ¨å®¢æˆ·ç«¯ç°åœ¨è¿˜æ˜¯æœ‰äº›é—®é¢˜çš„ã€‚



### 3.8 è‡ªå®šä¹‰æŒä¹…å±‚æ¡†æ¶ä¼˜åŒ–

**å®¢æˆ·ç«¯**

> å­˜åœ¨çš„é—®é¢˜ï¼šåœ¨ä¸Šé¢çš„å•å…ƒæµ‹è¯•test1ä¸­æœ‰è®¸å¤šä»£ç ï¼Œæ˜¾å¾—éå¸¸è‡ƒè‚¿ï¼ŒæŒ‰ç…§æ­£å¸¸æ€è·¯è¿™äº›ä»£ç åº”è¯¥å†™åœ¨æŒä¹…å±‚çš„æ–¹æ³•ä¸­(daoå±‚)

* **ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºUserDaoåŠå®ç°ç±»UserDaoImpl**

  åœ¨``com.eayon.dao``ä¸‹åˆ›å»º``UserDao``æ¥å£

  ```java
  package com.eayon.dao;
  
  import com.eayon.pojo.User;
  
  import java.util.List;
  
  /**
   * UserDao
   */
  public interface UserDao {
  
      //æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·
      public List<User> findAll() throws Exception;
  
      //æ ¹æ®æ¡ä»¶æŸ¥è¯¢
      public User findByCondition(User user) throws Exception;
  }
  ```

* **ç¬¬äºŒæ­¥ï¼šåˆ›å»ºå®ç°ç±»UserDaoImpl**

  åœ¨``com.eayon.dao``ä¸‹åˆ›å»ºå®ç°ç±»``UserDaoImpl``ï¼Œå°†åˆ›å»º``session``å·¥å‚ç­‰ä»£ç è½¬ç§»è‡³``dao``å±‚å®ç°ç±»

  ```java
  package com.eayon.dao;
  
  import com.eayon.io.Resources;
  import com.eayon.pojo.User;
  import com.eayon.sqlSession.SqlSession;
  import com.eayon.sqlSession.SqlSessionFactoryBuilder;
  import com.eayon.sqlSession.SqlsessionFactory;
  import java.io.InputStream;
  import java.util.List;
  
  /**
   * UserDao
   */
  public class UserDaoImpl implements UserDao {
      @Override
      public List<User> findAll() throws Exception {
          //è·å–æ ¸å¿ƒé…ç½®æ–‡ä»¶å­—èŠ‚æµ
          InputStream resourceAsStream = Resources.getResourceAsStream("sqlMapConfig.xml");
          //åˆ›å»ºsessionå·¥å‚
          SqlSessionFactoryBuilder sqlSessionFactoryBuilder = new SqlSessionFactoryBuilder();
          SqlsessionFactory sqlsessionFactory = sqlSessionFactoryBuilder.build(resourceAsStream);
          //é€šè¿‡sessionå·¥å‚åˆ›å»ºsession
          SqlSession sqlSession = sqlsessionFactory.openSession();
  
          //å‚æ•°ä¸€ï¼šstatementId  (statementId.id)
          List<User> users = sqlSession.selectList("user.selectList");
          return users;
      }
  
      @Override
      public User findByCondition(User user) throws Exception {
          //è·å–æ ¸å¿ƒé…ç½®æ–‡ä»¶å­—èŠ‚æµ
          InputStream resourceAsStream = Resources.getResourceAsStream("sqlMapConfig.xml");
          //åˆ›å»ºsessionå·¥å‚
          SqlSessionFactoryBuilder sqlSessionFactoryBuilder = new SqlSessionFactoryBuilder();
          SqlsessionFactory sqlsessionFactory = sqlSessionFactoryBuilder.build(resourceAsStream);
          //é€šè¿‡sessionå·¥å‚åˆ›å»ºsession
          SqlSession sqlSession = sqlsessionFactory.openSession();
          //é€šè¿‡sessionæ“ä½œæ•°æ®åº“æŸ¥è¯¢
          //å‚æ•°ä¸€ï¼šstatementId  (statementId.id)   å‚æ•°äºŒï¼šæŸ¥è¯¢å‚æ•°
          User user2 = sqlSession.selectOne("user.selectOne",user);
          return user2;
      }
  }
  ```

* **ç¬¬ä¸‰æ­¥ï¼šæµ‹è¯•**

  ```java
  @Test
  public void test2() throws Exception {
      UserDaoImpl userDao = new UserDaoImpl();
      List<User> users = userDao.findAll();
      System.out.println(users);
  }
  ```



**å¤šè¯´ä¸€å˜´**ï¼š

>**æœ¬ç« ç›¸å…³ä»£ç åŠç¬”è®°åœ°å€ï¼š**[**é£æœºç¥¨ğŸš€**](https://github.com/EayonLee/JavaGod/tree/main/1é˜¶æ®µï¼šå¼€æºæ¡†æ¶æºç å‰–æ/01æ¨¡å—ï¼šè‡ªå®šä¹‰æŒä¹…å±‚æ¡†æ¶è®¾è®¡åŠMyBatisæºç åˆ†æ)
>
>ğŸŒGithubï¼š[ğŸš€Javaè¶…ç¥ä¹‹è·¯ï¼šã€ğŸ”Javaå…¨ç”Ÿæ€æŠ€æœ¯å­¦ä¹ ç¬”è®°ï¼Œä¸€èµ·è¶…ç¥å§ğŸ”ã€‘](https://github.com/EayonLee/JavaGod)
>ğŸªCSDNï¼š[ğŸš€Javaè¶…ç¥ä¹‹è·¯ï¼šã€ğŸ”Javaå…¨ç”Ÿæ€æŠ€æœ¯å­¦ä¹ ç¬”è®°ï¼Œä¸€èµ·è¶…ç¥å§ğŸ”ã€‘](https://blog.csdn.net/qq_20492277/article/details/114269863)